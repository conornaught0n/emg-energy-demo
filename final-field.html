<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMG Surveyor Mode - Professional Survey System</title>
    <script src="job-types-config.js"></script>
    <script src="ai-processor.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: linear-gradient(135deg, #2C5F2D 0%, #1a3a1b 100%); min-height: 100vh; padding: 20px; }
        .card { background: white; padding: 25px; margin: 15px auto; max-width: 600px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        h1, h2 { color: #2C5F2D; }
        input, select { width: 100%; padding: 12px; font-size: 16px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; }
        button { width: 100%; padding: 15px; font-size: 18px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin: 8px 0; }
        .btn-green { background: #4CAF50; color: white; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-blue.recording { background: #D32F2F; animation: pulse 1s infinite; }
        .btn-orange { background: #FF9800; color: white; }
        .btn-purple { background: #9C27B0; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { background: #e8f5e9; border: 3px solid #4CAF50; padding: 15px; border-radius: 8px; margin: 10px 0; display: none; }
        .warning { background: #fff3cd; border: 2px solid #FF9800; padding: 15px; border-radius: 8px; text-align: center; }
        .note { background: #f5f5f5; padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #4CAF50; }
        .note-num { font-weight: bold; color: #2C5F2D; font-size: 13px; }
        .note-text { color: #333; margin-top: 5px; }
        .counts { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .count { background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; }
        .count-num { font-size: 28px; font-weight: bold; color: #2C5F2D; }
        .transcribe-box { background: #ffebee; border: 3px solid #D32F2F; padding: 15px; border-radius: 8px; margin: 10px 0; display: none; }
        .transcribe-box.active { display: block; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        /* Checklist Styles */
        .checklist { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; max-height: 400px; overflow-y: auto; }
        .checklist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .checklist-title { font-weight: bold; color: #2C5F2D; font-size: 16px; }
        .checklist-completion { font-size: 24px; font-weight: bold; color: #4CAF50; }
        .checklist-category { margin: 15px 0; }
        .category-name { font-weight: bold; color: #666; font-size: 14px; margin-bottom: 8px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        .checklist-item { display: flex; align-items: center; padding: 8px; margin: 5px 0; background: white; border-radius: 6px; border-left: 3px solid #ddd; }
        .checklist-item.checked { border-left-color: #4CAF50; background: #e8f5e9; }
        .checklist-checkbox { font-size: 20px; margin-right: 10px; min-width: 25px; }
        .checklist-item-name { flex: 1; font-size: 14px; color: #333; }
        .checklist-confidence { font-size: 11px; color: #4CAF50; font-weight: bold; }
        .missing-items { background: #fff3cd; border: 2px solid #FF9800; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .missing-items h3 { color: #856404; margin-bottom: 10px; font-size: 14px; }
        .missing-items ul { margin: 0 0 0 20px; color: #856404; font-size: 13px; }
    </style>
</head>
<body>
    <div class="card" style="text-align: center;">
        <img src="https://emgenergy.ie/wp-content/uploads/2024/05/EMG-Energy.png" style="height: 40px;">
        <h1 style="margin: 10px 0;">Surveyor Mode</h1>
        <p style="font-size: 14px; opacity: 0.9; margin: 0;">Professional On-Site Survey System</p>
    </div>

    <div class="card">
        <h2>1Ô∏è‚É£ Project</h2>
        <select id="projSel"></select>
        <div style="text-align: center; margin: 10px; color: #666;">OR</div>
        <input type="text" id="addr" placeholder="Enter address">

        <label style="display: block; margin-top: 15px; font-weight: bold; color: #333;">Survey Type:</label>
        <select id="jobType">
            <option value="">-- Select Survey Type --</option>
        </select>

        <button class="btn-green" onclick="createProj()">CREATE PROJECT</button>
        <div id="statusBox" class="status"></div>
        <div id="warnBox" class="warning">‚ö†Ô∏è Create or select project first</div>
    </div>

    <!-- AI CHECKLIST CARD -->
    <div class="card" id="checklistCard" style="display: none;">
        <h2>ü§ñ AI Survey Checklist</h2>
        <div id="checklistContent" class="checklist"></div>
        <div id="missingItems" class="missing-items" style="display: none;"></div>
    </div>

    <div class="card">
        <h2>2Ô∏è‚É£ Voice Notes</h2>
        <div id="transcribeBox" class="transcribe-box">
            <div style="color: #D32F2F; font-weight: bold;">üî¥ RECORDING...</div>
            <div id="transcribeText" style="font-size: 18px; margin-top: 10px;">Listening...</div>
        </div>
        <button class="btn-blue" id="recBtn" onclick="toggleRec()">üé§ RECORD (Auto-Transcribe)</button>
        <div class="counts">
            <div class="count"><div class="count-num" id="noteCount">0</div><div style="font-size: 12px;">Notes</div></div>
            <div class="count"><div class="count-num" id="projCount">0</div><div style="font-size: 12px;">Projects</div></div>
        </div>
        <div id="notesList"></div>
    </div>

    <div class="card">
        <h2>3Ô∏è‚É£ Save</h2>
        <button class="btn-orange" id="saveBtn" onclick="saveProj()">üíæ SAVE TO DASHBOARD</button>
        <button class="btn-purple" onclick="window.location.href='manager-dashboard.html'">üìä VIEW DASHBOARD</button>
    </div>

    <script>
        var STATE = {
            projId: null,
            projRef: null,
            addr: '',
            jobTypeId: null,
            notes: [],
            recording: false,
            recognition: null,
            transcript: '',
            checkedItems: {},
            jobType: null
        };

        function log(m) { console.log(m); }

        function loadJobTypes() {
            var types = getJobTypes();
            var sel = document.getElementById('jobType');

            for (var key in types) {
                if (types.hasOwnProperty(key)) {
                    var opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = types[key].icon + ' ' + types[key].name;
                    sel.appendChild(opt);
                }
            }
            log('‚úÖ Loaded ' + Object.keys(types).length + ' job types');
        }

        function createProj() {
            var addr = document.getElementById('addr').value.trim();
            var jobTypeId = document.getElementById('jobType').value;

            if (!addr) { alert('‚ùå Enter address!'); return; }
            if (!jobTypeId) { alert('‚ùå Select survey type!'); return; }

            STATE.projId = 'p' + Date.now();
            STATE.projRef = 'EMG-2026-' + Math.random().toString(36).substr(2,6).toUpperCase();
            STATE.addr = addr;
            STATE.jobTypeId = jobTypeId;
            STATE.jobType = getJobType(jobTypeId);
            STATE.notes = [];
            STATE.checkedItems = {};

            log('‚úÖ Created: ' + STATE.projRef + ' (' + STATE.jobType.name + ')');
            updateUI();
            displayChecklist();
        }

        function toggleRec() {
            if (!STATE.projId) { alert('‚ùå Create project first!'); return; }
            STATE.recording ? stopRec() : startRec();
        }

        function startRec() {
            log('üé§ Starting...');
            var box = document.getElementById('transcribeBox');
            var text = document.getElementById('transcribeText');
            var btn = document.getElementById('recBtn');

            box.classList.add('active');
            btn.classList.add('recording');
            btn.textContent = '‚èπÔ∏è STOP';
            STATE.recording = true;
            STATE.transcript = '';
            text.textContent = 'Listening...';

            var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) { alert('‚ùå Speech not supported! Use Chrome.'); stopRec(); return; }

            STATE.recognition = new SR();
            STATE.recognition.continuous = true;
            STATE.recognition.interimResults = true;
            STATE.recognition.lang = 'en-IE';

            var finalTranscript = '';
            var interimTranscript = '';

            STATE.recognition.onresult = function(e) {
                interimTranscript = '';

                for (var i = e.resultIndex; i < e.results.length; i++) {
                    var transcript = e.results[i][0].transcript;
                    if (e.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                STATE.transcript = (finalTranscript + interimTranscript).trim();
                text.textContent = STATE.transcript || 'Listening...';
            };

            STATE.recognition.onerror = function(e) {
                log('‚ùå Error: ' + e.error);
                if (e.error === 'not-allowed') alert('‚ùå Allow microphone access!');
                stopRec();
            };

            STATE.recognition.onend = function() {
                if (!STATE.recording) return;
                log('‚ö†Ô∏è Recognition ended, restarting...');
                try {
                    if (STATE.recognition) STATE.recognition.start();
                } catch(err) {
                    log('‚ùå Restart failed: ' + err.message);
                }
            };

            try {
                STATE.recognition.start();
                log('‚úÖ Recording started');
            } catch(e) {
                log('‚ùå Start failed: ' + e.message);
                alert('‚ùå ' + e.message);
                stopRec();
            }
        }

        function stopRec() {
            STATE.recording = false;
            if (STATE.recognition) {
                STATE.recognition.stop();
                STATE.recognition = null;
            }
            if (STATE.transcript) saveNote();
            document.getElementById('transcribeBox').classList.remove('active');
            document.getElementById('recBtn').classList.remove('recording');
            document.getElementById('recBtn').textContent = 'üé§ RECORD (Auto-Transcribe)';
            log('‚èπÔ∏è Stopped');
        }

        function saveNote() {
            if (!STATE.transcript) return;
            var noteObj = { id: 'n' + Date.now(), transcription: STATE.transcript, captured_at: new Date().toISOString() };
            STATE.notes.push(noteObj);
            log('‚úÖ Note saved: ' + STATE.transcript);

            // Run AI analysis if job type exists
            if (STATE.jobType) {
                log('ü§ñ Running AI analysis...');
                var matches = AI_PROCESSOR.analyzeVoiceNote(STATE.transcript, STATE.jobType);
                for (var i = 0; i < matches.length; i++) {
                    STATE.checkedItems[matches[i].itemId] = {
                        checked: true,
                        confidence: matches[i].confidence,
                        source: 'voice',
                        noteIndex: STATE.notes.length - 1
                    };
                }
                log('ü§ñ AI found ' + matches.length + ' matches');
                displayChecklist();
            }

            STATE.transcript = '';
            updateUI();
        }

        function saveProj() {
            if (!STATE.projId) { alert('‚ùå Create project first!'); return; }
            if (STATE.notes.length === 0) { alert('‚ùå Add notes first!'); return; }

            var btn = document.getElementById('saveBtn');
            btn.textContent = '‚è≥ SAVING...';
            btn.disabled = true;

            try {
                var job = {
                    jobId: STATE.projId,
                    projectReference: STATE.projRef,
                    address: STATE.addr,
                    jobTypeId: STATE.jobTypeId,
                    createdAt: new Date().toISOString(),
                    status: 'in-progress',
                    voiceNotes: STATE.notes,
                    photos: [],
                    managerInputs: {},
                    checkedItems: STATE.checkedItems
                };

                var jobs = JSON.parse(localStorage.getItem('emg_all_jobs') || '[]');
                var idx = -1;
                for (var i = 0; i < jobs.length; i++) {
                    if (jobs[i].jobId === STATE.projId) { idx = i; break; }
                }

                if (idx >= 0) jobs[idx] = job; else jobs.push(job);

                localStorage.setItem('emg_all_jobs', JSON.stringify(jobs));

                log('‚úÖ SAVED! Jobs: ' + jobs.length);

                btn.textContent = '‚úÖ SAVED!';
                setTimeout(function() { btn.textContent = 'üíæ SAVE TO DASHBOARD'; btn.disabled = false; }, 2000);

                loadProjs();

            } catch(e) {
                log('‚ùå Save failed: ' + e.message);
                alert('‚ùå ' + e.message);
                btn.textContent = 'üíæ SAVE TO DASHBOARD';
                btn.disabled = false;
            }
        }

        function loadProjs() {
            var sel = document.getElementById('projSel');
            sel.innerHTML = '<option value="">-- Select Project --</option>';

            try {
                var jobs = JSON.parse(localStorage.getItem('emg_all_jobs') || '[]');
                for (var i = 0; i < jobs.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = jobs[i].jobId;
                    opt.textContent = jobs[i].projectReference + ' - ' + jobs[i].address;
                    sel.appendChild(opt);
                }

                sel.onchange = function() {
                    for (var i = 0; i < jobs.length; i++) {
                        if (jobs[i].jobId === sel.value) {
                            STATE.projId = jobs[i].jobId;
                            STATE.projRef = jobs[i].projectReference;
                            STATE.addr = jobs[i].address;
                            STATE.notes = jobs[i].voiceNotes.map(function(n) {
                                return { id: n.id, text: n.transcription, time: n.captured_at };
                            });
                            document.getElementById('addr').value = STATE.addr;
                            log('‚úÖ Loaded: ' + STATE.projRef);
                            updateUI();
                            break;
                        }
                    }
                };

                document.getElementById('projCount').textContent = jobs.length;
                log('üìã ' + jobs.length + ' projects');

            } catch(e) {
                log('‚ùå Load error: ' + e.message);
            }
        }

        function updateUI() {
            document.getElementById('noteCount').textContent = STATE.notes.length;

            var status = document.getElementById('statusBox');
            var warn = document.getElementById('warnBox');
            var saveBtn = document.getElementById('saveBtn');

            if (STATE.projId) {
                status.style.display = 'block';
                status.innerHTML = '<strong>‚úÖ ACTIVE</strong><br>' + STATE.projRef + '<br>' + STATE.addr;
                warn.style.display = 'none';
                saveBtn.disabled = STATE.notes.length === 0;
                saveBtn.textContent = STATE.notes.length > 0 ? 'üíæ SAVE (' + STATE.notes.length + ' notes)' : 'üíæ SAVE TO DASHBOARD';
            } else {
                status.style.display = 'none';
                warn.style.display = 'block';
                saveBtn.disabled = true;
                saveBtn.textContent = '‚ö†Ô∏è CREATE PROJECT FIRST';
            }

            var list = document.getElementById('notesList');
            if (STATE.notes.length === 0) {
                list.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No notes yet</div>';
            } else {
                list.innerHTML = '<h3 style="margin: 15px 0 10px 0;">Notes:</h3>';
                for (var i = 0; i < STATE.notes.length; i++) {
                    list.innerHTML += '<div class="note"><div class="note-num">Note ' + (i+1) + '</div><div class="note-text">' + STATE.notes[i].text + '</div></div>';
                }
            }
        }

        function displayChecklist() {
            if (!STATE.jobType) {
                document.getElementById('checklistCard').style.display = 'none';
                return;
            }

            document.getElementById('checklistCard').style.display = 'block';

            var totalItems = 0;
            var checkedCount = 0;

            // Count total items and checked items
            for (var i = 0; i < STATE.jobType.checklist.length; i++) {
                totalItems += STATE.jobType.checklist[i].items.length;
            }
            checkedCount = Object.keys(STATE.checkedItems).length;

            var completionPct = totalItems > 0 ? Math.round((checkedCount / totalItems) * 100) : 0;

            var html = '<div class="checklist-header">' +
                '<div class="checklist-title">üìã Survey Progress</div>' +
                '<div class="checklist-completion">' + completionPct + '%</div>' +
                '</div>';

            // Display checklist categories and items
            for (var i = 0; i < STATE.jobType.checklist.length; i++) {
                var category = STATE.jobType.checklist[i];
                html += '<div class="checklist-category">';
                html += '<div class="category-name">' + category.category + '</div>';

                for (var j = 0; j < category.items.length; j++) {
                    var item = category.items[j];
                    var isChecked = STATE.checkedItems[item.id];
                    var checkClass = isChecked ? 'checked' : '';
                    var checkIcon = isChecked ? '‚úÖ' : '‚¨ú';
                    var confidenceText = isChecked ? '<span class="checklist-confidence">(' + isChecked.confidence + '%)</span>' : '';

                    html += '<div class="checklist-item ' + checkClass + '">' +
                        '<span class="checklist-checkbox">' + checkIcon + '</span>' +
                        '<span class="checklist-item-name">' + item.name + '</span>' +
                        confidenceText +
                        '</div>';
                }

                html += '</div>';
            }

            document.getElementById('checklistContent').innerHTML = html;

            // Show missing items if completion < 100%
            if (completionPct < 100) {
                var missing = [];
                for (var i = 0; i < STATE.jobType.checklist.length; i++) {
                    var category = STATE.jobType.checklist[i];
                    for (var j = 0; j < category.items.length; j++) {
                        var item = category.items[j];
                        if (!STATE.checkedItems[item.id]) {
                            missing.push(item.name);
                        }
                    }
                }

                if (missing.length > 0 && missing.length <= 10) {
                    var missingHtml = '<h3>‚ö†Ô∏è Outstanding Items (' + missing.length + '):</h3><ul>';
                    for (var i = 0; i < Math.min(missing.length, 5); i++) {
                        missingHtml += '<li>' + missing[i] + '</li>';
                    }
                    if (missing.length > 5) {
                        missingHtml += '<li>...and ' + (missing.length - 5) + ' more</li>';
                    }
                    missingHtml += '</ul>';
                    document.getElementById('missingItems').innerHTML = missingHtml;
                    document.getElementById('missingItems').style.display = 'block';
                } else {
                    document.getElementById('missingItems').style.display = 'none';
                }
            } else {
                document.getElementById('missingItems').style.display = 'none';
            }
        }

        log('üöÄ Loading...');
        loadJobTypes();
        loadProjs();
        updateUI();
        log('‚úÖ Ready');
    </script>
</body>
</html>
