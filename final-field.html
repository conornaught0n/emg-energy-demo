<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMG Surveyor Mode - Professional Survey System</title>
    <script src="job-types-config.js"></script>
    <script src="ai-processor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: linear-gradient(135deg, #2C5F2D 0%, #1a3a1b 100%); min-height: 100vh; padding: 20px; }
        .card { background: white; padding: 25px; margin: 15px auto; max-width: 600px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        h1, h2 { color: #2C5F2D; }
        input, select { width: 100%; padding: 12px; font-size: 16px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; }
        button { width: 100%; padding: 15px; font-size: 18px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin: 8px 0; }
        .btn-green { background: #4CAF50; color: white; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-blue.recording { background: #D32F2F; animation: pulse 1s infinite; }
        .btn-orange { background: #FF9800; color: white; }
        .btn-purple { background: #9C27B0; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { background: #e8f5e9; border: 3px solid #4CAF50; padding: 15px; border-radius: 8px; margin: 10px 0; display: none; }
        .warning { background: #fff3cd; border: 2px solid #FF9800; padding: 15px; border-radius: 8px; text-align: center; }
        .note { background: #f5f5f5; padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #4CAF50; }
        .note-num { font-weight: bold; color: #2C5F2D; font-size: 13px; }
        .note-text { color: #333; margin-top: 5px; }
        .counts { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .count { background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; }
        .count-num { font-size: 28px; font-weight: bold; color: #2C5F2D; }
        .transcribe-box { background: #ffebee; border: 3px solid #D32F2F; padding: 15px; border-radius: 8px; margin: 10px 0; display: none; }
        .transcribe-box.active { display: block; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        /* Checklist Styles */
        .checklist { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; max-height: 400px; overflow-y: auto; }
        .checklist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .checklist-title { font-weight: bold; color: #2C5F2D; font-size: 16px; }
        .checklist-completion { font-size: 24px; font-weight: bold; color: #4CAF50; }
        .checklist-category { margin: 15px 0; }
        .category-name { font-weight: bold; color: #666; font-size: 14px; margin-bottom: 8px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        .checklist-item { display: flex; align-items: center; padding: 8px; margin: 5px 0; background: white; border-radius: 6px; border-left: 3px solid #ddd; }
        .checklist-item.checked { border-left-color: #4CAF50; background: #e8f5e9; }
        .checklist-checkbox { font-size: 20px; margin-right: 10px; min-width: 25px; }
        .checklist-item-name { flex: 1; font-size: 14px; color: #333; }
        .checklist-confidence { font-size: 11px; color: #4CAF50; font-weight: bold; }
        .missing-items { background: #fff3cd; border: 2px solid #FF9800; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .missing-items h3 { color: #856404; margin-bottom: 10px; font-size: 14px; }
        .missing-items ul { margin: 0 0 0 20px; color: #856404; font-size: 13px; }

        /* Photo Styles */
        #photosPreview { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin: 10px 0; }
        .photo-preview { position: relative; border-radius: 8px; overflow: hidden; border: 2px solid #ddd; aspect-ratio: 4/3; }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .photo-delete { position: absolute; top: 5px; right: 5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; }
        .btn-secondary { background: #2196F3; color: white; }
    </style>
</head>
<body>
    <div class="card" style="text-align: center;">
        <img src="https://emgenergy.ie/wp-content/uploads/2024/05/EMG-Energy.png" style="height: 40px;">
        <h1 style="margin: 10px 0;">Surveyor Mode</h1>
        <p style="font-size: 14px; opacity: 0.9; margin: 0;">Professional On-Site Survey System</p>
    </div>

    <div class="card">
        <h2>1Ô∏è‚É£ Project</h2>
        <select id="projSel"></select>
        <div style="text-align: center; margin: 10px; color: #666;">OR</div>
        <input type="text" id="addr" placeholder="Enter address">

        <label style="display: block; margin-top: 15px; font-weight: bold; color: #333;">Survey Type:</label>
        <select id="jobType">
            <option value="">-- Select Survey Type --</option>
        </select>

        <button class="btn-green" onclick="createProj()">CREATE PROJECT</button>
        <div id="statusBox" class="status"></div>
        <div id="warnBox" class="warning">‚ö†Ô∏è Create or select project first</div>
    </div>

    <!-- AI CHECKLIST CARD -->
    <div class="card" id="checklistCard" style="display: none;">
        <h2>ü§ñ AI Survey Checklist</h2>
        <div id="checklistContent" class="checklist"></div>
        <div id="missingItems" class="missing-items" style="display: none;"></div>
    </div>

    <div class="card">
        <h2>2Ô∏è‚É£ Survey Data Capture</h2>

        <h3 style="margin-top: 20px; color: #2C5F2D;">üì∑ Photos & Images</h3>
        <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Capture equipment screens, clipboard data, or site photos</p>

        <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhoto(event)">
        <button class="btn-secondary" onclick="document.getElementById('photoInput').click()">üì∏ Take Photo</button>

        <div id="photosPreview" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;"></div>

        <h3 style="margin-top: 20px; color: #2C5F2D;">üé§ Voice Notes</h3>
        <div id="transcribeBox" class="transcribe-box">
            <div style="color: #D32F2F; font-weight: bold;">üî¥ RECORDING...</div>
            <div id="transcribeText" style="font-size: 18px; margin-top: 10px;">Listening...</div>
        </div>
        <button class="btn-blue" id="recBtn" onclick="toggleRec()">üé§ RECORD (Auto-Transcribe)</button>
        <div class="counts">
            <div class="count"><div class="count-num" id="noteCount">0</div><div style="font-size: 12px;">Voice Notes</div></div>
            <div class="count"><div class="count-num" id="photoCount">0</div><div style="font-size: 12px;">Photos</div></div>
        </div>
        <div id="notesList"></div>
    </div>

    <div class="card">
        <h2>3Ô∏è‚É£ Save</h2>
        <button class="btn-orange" id="saveBtn" onclick="saveProj()">üíæ SAVE TO DASHBOARD</button>
        <button class="btn-purple" onclick="window.location.href='manager-dashboard.html'">üìä VIEW DASHBOARD</button>
    </div>

    <script>
        var STATE = {
            projId: null,
            projRef: null,
            addr: '',
            jobTypeId: null,
            notes: [],
            photos: [],
            recording: false,
            recognition: null,
            transcript: '',
            checkedItems: {},
            jobType: null
        };

        function log(m) { console.log(m); }

        function loadJobTypes() {
            var types = getJobTypes();
            var sel = document.getElementById('jobType');

            for (var key in types) {
                if (types.hasOwnProperty(key)) {
                    var opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = types[key].icon + ' ' + types[key].name;
                    sel.appendChild(opt);
                }
            }
            log('‚úÖ Loaded ' + Object.keys(types).length + ' job types');
        }

        function createProj() {
            var addr = document.getElementById('addr').value.trim();
            var jobTypeId = document.getElementById('jobType').value;

            if (!addr) { alert('‚ùå Enter address!'); return; }
            if (!jobTypeId) { alert('‚ùå Select survey type!'); return; }

            STATE.projId = 'p' + Date.now();
            STATE.projRef = 'EMG-2026-' + Math.random().toString(36).substr(2,6).toUpperCase();
            STATE.addr = addr;
            STATE.jobTypeId = jobTypeId;
            STATE.jobType = getJobType(jobTypeId);
            STATE.notes = [];
            STATE.photos = [];
            STATE.checkedItems = {};

            log('‚úÖ Created: ' + STATE.projRef + ' (' + STATE.jobType.name + ')');
            updateUI();
            displayChecklist();
        }

        function toggleRec() {
            if (!STATE.projId) { alert('‚ùå Create project first!'); return; }
            STATE.recording ? stopRec() : startRec();
        }

        function startRec() {
            log('üé§ Starting...');
            var box = document.getElementById('transcribeBox');
            var text = document.getElementById('transcribeText');
            var btn = document.getElementById('recBtn');

            box.classList.add('active');
            btn.classList.add('recording');
            btn.textContent = '‚èπÔ∏è STOP';
            STATE.recording = true;
            STATE.transcript = '';
            text.textContent = 'Listening...';

            var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) { alert('‚ùå Speech not supported! Use Chrome.'); stopRec(); return; }

            STATE.recognition = new SR();
            STATE.recognition.continuous = true;
            STATE.recognition.interimResults = true;
            STATE.recognition.lang = 'en-IE';

            var finalTranscript = '';
            var interimTranscript = '';

            STATE.recognition.onresult = function(e) {
                interimTranscript = '';

                for (var i = e.resultIndex; i < e.results.length; i++) {
                    var transcript = e.results[i][0].transcript;
                    if (e.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                STATE.transcript = (finalTranscript + interimTranscript).trim();
                text.textContent = STATE.transcript || 'Listening...';
            };

            STATE.recognition.onerror = function(e) {
                log('‚ùå Error: ' + e.error);
                if (e.error === 'not-allowed') alert('‚ùå Allow microphone access!');
                stopRec();
            };

            STATE.recognition.onend = function() {
                if (!STATE.recording) return;
                log('‚ö†Ô∏è Recognition ended, restarting...');
                try {
                    if (STATE.recognition) STATE.recognition.start();
                } catch(err) {
                    log('‚ùå Restart failed: ' + err.message);
                }
            };

            try {
                STATE.recognition.start();
                log('‚úÖ Recording started');
            } catch(e) {
                log('‚ùå Start failed: ' + e.message);
                alert('‚ùå ' + e.message);
                stopRec();
            }
        }

        function stopRec() {
            STATE.recording = false;
            if (STATE.recognition) {
                STATE.recognition.stop();
                STATE.recognition = null;
            }
            if (STATE.transcript) saveNote();
            document.getElementById('transcribeBox').classList.remove('active');
            document.getElementById('recBtn').classList.remove('recording');
            document.getElementById('recBtn').textContent = 'üé§ RECORD (Auto-Transcribe)';
            log('‚èπÔ∏è Stopped');
        }

        function saveNote() {
            if (!STATE.transcript) return;
            var noteObj = { id: 'n' + Date.now(), transcription: STATE.transcript, captured_at: new Date().toISOString() };
            STATE.notes.push(noteObj);
            log('‚úÖ Note saved: ' + STATE.transcript);

            // Run AI analysis if job type exists
            if (STATE.jobType) {
                log('ü§ñ Running AI analysis...');
                var matches = AI_PROCESSOR.analyzeVoiceNote(STATE.transcript, STATE.jobType);
                for (var i = 0; i < matches.length; i++) {
                    STATE.checkedItems[matches[i].itemId] = {
                        checked: true,
                        confidence: matches[i].confidence,
                        source: 'voice',
                        noteIndex: STATE.notes.length - 1
                    };
                }
                log('ü§ñ AI found ' + matches.length + ' matches');
                displayChecklist();
            }

            STATE.transcript = '';
            updateUI();
        }

        function saveProj() {
            if (!STATE.projId) { alert('‚ùå Create project first!'); return; }
            if (STATE.notes.length === 0) { alert('‚ùå Add notes first!'); return; }

            var btn = document.getElementById('saveBtn');
            btn.textContent = '‚è≥ SAVING...';
            btn.disabled = true;

            try {
                var job = {
                    jobId: STATE.projId,
                    projectReference: STATE.projRef,
                    address: STATE.addr,
                    jobTypeId: STATE.jobTypeId,
                    createdAt: new Date().toISOString(),
                    status: 'in-progress',
                    voiceNotes: STATE.notes,
                    photos: STATE.photos,
                    managerInputs: {},
                    checkedItems: STATE.checkedItems
                };

                var jobs = JSON.parse(localStorage.getItem('emg_all_jobs') || '[]');
                var idx = -1;
                for (var i = 0; i < jobs.length; i++) {
                    if (jobs[i].jobId === STATE.projId) { idx = i; break; }
                }

                if (idx >= 0) jobs[idx] = job; else jobs.push(job);

                localStorage.setItem('emg_all_jobs', JSON.stringify(jobs));

                log('‚úÖ SAVED! Jobs: ' + jobs.length);

                btn.textContent = '‚úÖ SAVED!';
                setTimeout(function() { btn.textContent = 'üíæ SAVE TO DASHBOARD'; btn.disabled = false; }, 2000);

                loadProjs();

            } catch(e) {
                log('‚ùå Save failed: ' + e.message);
                alert('‚ùå ' + e.message);
                btn.textContent = 'üíæ SAVE TO DASHBOARD';
                btn.disabled = false;
            }
        }

        function loadProjs() {
            var sel = document.getElementById('projSel');
            sel.innerHTML = '<option value="">-- Select Project --</option>';

            try {
                var jobs = JSON.parse(localStorage.getItem('emg_all_jobs') || '[]');
                for (var i = 0; i < jobs.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = jobs[i].jobId;
                    opt.textContent = jobs[i].projectReference + ' - ' + jobs[i].address;
                    sel.appendChild(opt);
                }

                sel.onchange = function() {
                    for (var i = 0; i < jobs.length; i++) {
                        if (jobs[i].jobId === sel.value) {
                            STATE.projId = jobs[i].jobId;
                            STATE.projRef = jobs[i].projectReference;
                            STATE.addr = jobs[i].address;
                            STATE.notes = jobs[i].voiceNotes.map(function(n) {
                                return { id: n.id, text: n.transcription, time: n.captured_at };
                            });
                            document.getElementById('addr').value = STATE.addr;
                            log('‚úÖ Loaded: ' + STATE.projRef);
                            updateUI();
                            break;
                        }
                    }
                };

                document.getElementById('projCount').textContent = jobs.length;
                log('üìã ' + jobs.length + ' projects');

            } catch(e) {
                log('‚ùå Load error: ' + e.message);
            }
        }

        function updateUI() {
            document.getElementById('noteCount').textContent = STATE.notes.length;
            document.getElementById('photoCount').textContent = STATE.photos.length;

            var status = document.getElementById('statusBox');
            var warn = document.getElementById('warnBox');
            var saveBtn = document.getElementById('saveBtn');

            if (STATE.projId) {
                status.style.display = 'block';
                status.innerHTML = '<strong>‚úÖ ACTIVE</strong><br>' + STATE.projRef + '<br>' + STATE.addr;
                warn.style.display = 'none';
                saveBtn.disabled = STATE.notes.length === 0;
                saveBtn.textContent = STATE.notes.length > 0 ? 'üíæ SAVE (' + STATE.notes.length + ' notes)' : 'üíæ SAVE TO DASHBOARD';
            } else {
                status.style.display = 'none';
                warn.style.display = 'block';
                saveBtn.disabled = true;
                saveBtn.textContent = '‚ö†Ô∏è CREATE PROJECT FIRST';
            }

            var list = document.getElementById('notesList');
            if (STATE.notes.length === 0) {
                list.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No notes yet</div>';
            } else {
                list.innerHTML = '<h3 style="margin: 15px 0 10px 0;">Notes:</h3>';
                for (var i = 0; i < STATE.notes.length; i++) {
                    list.innerHTML += '<div class="note"><div class="note-num">Note ' + (i+1) + '</div><div class="note-text">' + STATE.notes[i].text + '</div></div>';
                }
            }
        }

        function handlePhoto(event) {
            if (!STATE.projId) {
                alert('‚ùå Create project first!');
                event.target.value = '';
                return;
            }

            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    // Compress image using canvas
                    var maxWidth = 1200;
                    var maxHeight = 1200;
                    var width = img.width;
                    var height = img.height;

                    // Calculate new dimensions
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    // Create canvas and compress
                    var canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to compressed JPEG (quality: 0.7 = 70%)
                    var compressedData = canvas.toDataURL('image/jpeg', 0.7);

                    log('üì∑ Photo compressed: ' + Math.round(e.target.result.length / 1024) + 'KB ‚Üí ' + Math.round(compressedData.length / 1024) + 'KB');

                    var photo = {
                        id: 'photo-' + Date.now(),
                        data: compressedData,
                        timestamp: new Date().toISOString(),
                        type: 'equipment',
                        extracted: null // Will store OCR text
                    };

                    STATE.photos.push(photo);
                    log('üì∑ Photo added (' + STATE.photos.length + ' total)');
                    displayPhotos();
                    updateUI();

                    // Attempt OCR text extraction in background
                    extractTextFromPhoto(photo, compressedData);
                };
                img.src = e.target.result;
            };

            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function extractTextFromPhoto(photo, imageData) {
            // Use Tesseract.js for real OCR text extraction
            log('üîç Analyzing photo with OCR (this may take 10-15 seconds)...');

            if (!window.Tesseract) {
                log('‚ö†Ô∏è OCR library not loaded, skipping text extraction');
                return;
            }

            Tesseract.recognize(
                imageData,
                'eng',
                {
                    logger: function(m) {
                        if (m.status === 'recognizing text') {
                            var percent = Math.round(m.progress * 100);
                            if (percent % 20 === 0) { // Log every 20%
                                log('üìä OCR Progress: ' + percent + '%');
                            }
                        }
                    }
                }
            ).then(function(result) {
                var extractedText = result.data.text.trim();

                if (extractedText.length > 10) {
                    log('‚úÖ OCR Complete: Found ' + extractedText.length + ' characters');

                    // Process extracted text for BER-relevant data
                    var processedData = processExtractedText(extractedText);

                    photo.extracted = processedData;

                    // Create a voice note from extracted text
                    var timestamp = new Date(photo.timestamp).toLocaleTimeString();
                    var autoNote = {
                        id: 'ocr-' + Date.now(),
                        transcription: '[OCR from Photo ' + timestamp + '] ' + processedData,
                        captured_at: photo.timestamp,
                        source: 'ocr'
                    };

                    STATE.notes.push(autoNote);

                    // Analyze extracted text with AI
                    if (STATE.jobType && window.AI_PROCESSOR) {
                        var matches = AI_PROCESSOR.analyzeVoiceNote(processedData, STATE.jobType);
                        for (var i = 0; i < matches.length; i++) {
                            var key = matches[i].itemId;
                            if (!STATE.checkedItems[key] || STATE.checkedItems[key].confidence < matches[i].confidence) {
                                STATE.checkedItems[key] = {
                                    checked: true,
                                    confidence: matches[i].confidence,
                                    source: 'ocr'
                                };
                            }
                        }
                        displayChecklist();
                    }

                    log('üìã OCR text analyzed and added to survey data');
                    alert('‚úÖ Photo Text Extracted!\n\nFound equipment data in photo:\n' + processedData.substring(0, 150) + '...\n\nData has been analyzed and added to survey notes.');
                } else {
                    log('‚ÑπÔ∏è OCR found minimal text in photo');
                    photo.extracted = '[No readable text found in photo]';
                }
            }).catch(function(err) {
                log('‚ùå OCR Error: ' + err.message);
                photo.extracted = '[OCR failed - manual review required]';
            });
        }

        function processExtractedText(rawText) {
            // Clean and process OCR text to extract BER-relevant information
            var processed = rawText;

            // Remove excessive whitespace and line breaks
            processed = processed.replace(/\s+/g, ' ').trim();

            // Look for common equipment data patterns
            var keywords = {
                boiler: ['boiler', 'worcester', 'vaillant', 'ideal', 'baxi', 'combi', 'condensing', 'kw', 'kilowatt'],
                efficiency: ['efficiency', 'sedbuk', 'erp', 'rating', 'class', 'grade'],
                temperature: ['¬∞c', 'degrees', 'temp', 'temperature', 'flow', 'return'],
                insulation: ['mm', 'millimeter', 'thickness', 'insulation', 'mineral wool', 'cavity', 'u-value'],
                controls: ['thermostat', 'timer', 'programmer', 'trv', 'valve', 'control'],
                serial: ['serial', 'model', 'type', 'reference', 'product']
            };

            var identified = [];
            var recommendations = [];

            for (var category in keywords) {
                for (var i = 0; i < keywords[category].length; i++) {
                    if (processed.toLowerCase().indexOf(keywords[category][i]) !== -1) {
                        identified.push(category);
                        break;
                    }
                }
            }

            // Generate AI recommendations based on detected equipment
            var lowerText = processed.toLowerCase();

            if (identified.indexOf('boiler') !== -1) {
                recommendations.push('AI Recommendation: Document boiler specifications (make, model, kW output, age) for DEAP assessment. Verify SEDBUK rating and service history.');

                // Check for old boiler indicators
                if (lowerText.match(/\d{4}/) && parseInt(lowerText.match(/\d{4}/)[0]) < 2010) {
                    recommendations.push('AI Alert: Boiler appears to be pre-2010. Consider efficiency assessment and potential replacement recommendation.');
                }
            }

            if (identified.indexOf('temperature') !== -1) {
                var tempMatch = lowerText.match(/(\d+)\s*¬∞?c/);
                if (tempMatch) {
                    var temp = parseInt(tempMatch[1]);
                    if (temp < 18) {
                        recommendations.push('AI Recommendation: Temperature (' + temp + '¬∞C) below TGD L comfort standards (21¬∞C living areas). Investigate heating system performance and building fabric thermal loss.');
                    } else if (temp > 23) {
                        recommendations.push('AI Recommendation: Temperature (' + temp + '¬∞C) above typical comfort range. May indicate overheating risk - check solar gain, ventilation, and thermostat settings.');
                    }
                }
            }

            if (identified.indexOf('insulation') !== -1) {
                var mmMatch = lowerText.match(/(\d+)\s*mm/);
                if (mmMatch) {
                    var depth = parseInt(mmMatch[1]);
                    if (depth < 100) {
                        recommendations.push('AI Recommendation: Insulation depth (' + depth + 'mm) critically below Part L standards (300mm required). Priority upgrade to achieve U-value ‚â§0.16 W/m¬≤K.');
                    } else if (depth < 200) {
                        recommendations.push('AI Recommendation: Insulation depth (' + depth + 'mm) below current standards. Recommend top-up to 300mm for Part L compliance and optimal thermal performance.');
                    }
                }
            }

            if (identified.indexOf('serial') !== -1 || identified.indexOf('efficiency') !== -1) {
                recommendations.push('AI Recommendation: Equipment serial number/rating captured. Cross-reference with manufacturer database for detailed specifications and efficiency data.');
            }

            // Build final processed text with recommendations
            var finalText = 'Equipment data detected: ' + identified.join(', ') + '. ' + processed;

            if (recommendations.length > 0) {
                finalText += '\n\nüìä AI ANALYSIS:\n' + recommendations.join('\n');
            }

            return finalText;
        }

        function displayPhotos() {
            var container = document.getElementById('photosPreview');
            if (STATE.photos.length === 0) {
                container.innerHTML = '';
                return;
            }

            var html = '';
            for (var i = 0; i < STATE.photos.length; i++) {
                var ocrBadge = '';
                if (STATE.photos[i].extracted && STATE.photos[i].extracted !== '[OCR failed - manual review required]' && STATE.photos[i].extracted !== '[No readable text found in photo]') {
                    ocrBadge = '<span style="position: absolute; top: 5px; left: 5px; background: #2c5f2d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7em;">üìã OCR</span>';
                }
                html += '<div class="photo-preview">' +
                    '<img src="' + STATE.photos[i].data + '" alt="Photo ' + (i+1) + '">' +
                    ocrBadge +
                    '<button class="photo-delete" onclick="deletePhoto(' + i + ')">&times;</button>' +
                    '</div>';
            }
            container.innerHTML = html;
        }

        function deletePhoto(index) {
            if (!confirm('Delete this photo?')) return;
            STATE.photos.splice(index, 1);
            log('üóëÔ∏è Photo deleted');
            displayPhotos();
            updateUI();
        }

        function displayChecklist() {
            if (!STATE.jobType) {
                document.getElementById('checklistCard').style.display = 'none';
                return;
            }

            document.getElementById('checklistCard').style.display = 'block';

            var totalItems = 0;
            var checkedCount = 0;

            // Count total items and checked items
            for (var i = 0; i < STATE.jobType.checklist.length; i++) {
                totalItems += STATE.jobType.checklist[i].items.length;
            }
            checkedCount = Object.keys(STATE.checkedItems).length;

            var completionPct = totalItems > 0 ? Math.round((checkedCount / totalItems) * 100) : 0;

            var html = '<div class="checklist-header">' +
                '<div class="checklist-title">üìã Survey Progress</div>' +
                '<div class="checklist-completion">' + completionPct + '%</div>' +
                '</div>';

            // Display checklist categories and items
            for (var i = 0; i < STATE.jobType.checklist.length; i++) {
                var category = STATE.jobType.checklist[i];
                html += '<div class="checklist-category">';
                html += '<div class="category-name">' + category.category + '</div>';

                for (var j = 0; j < category.items.length; j++) {
                    var item = category.items[j];
                    var isChecked = STATE.checkedItems[item.id];
                    var checkClass = isChecked ? 'checked' : '';
                    var checkIcon = isChecked ? '‚úÖ' : '‚¨ú';
                    var confidenceText = isChecked ? '<span class="checklist-confidence">(' + isChecked.confidence + '%)</span>' : '';

                    html += '<div class="checklist-item ' + checkClass + '">' +
                        '<span class="checklist-checkbox">' + checkIcon + '</span>' +
                        '<span class="checklist-item-name">' + item.name + '</span>' +
                        confidenceText +
                        '</div>';
                }

                html += '</div>';
            }

            document.getElementById('checklistContent').innerHTML = html;

            // Show missing items if completion < 100%
            if (completionPct < 100) {
                var missing = [];
                for (var i = 0; i < STATE.jobType.checklist.length; i++) {
                    var category = STATE.jobType.checklist[i];
                    for (var j = 0; j < category.items.length; j++) {
                        var item = category.items[j];
                        if (!STATE.checkedItems[item.id]) {
                            missing.push(item.name);
                        }
                    }
                }

                if (missing.length > 0 && missing.length <= 10) {
                    var missingHtml = '<h3>‚ö†Ô∏è Outstanding Items (' + missing.length + '):</h3><ul>';
                    for (var i = 0; i < Math.min(missing.length, 5); i++) {
                        missingHtml += '<li>' + missing[i] + '</li>';
                    }
                    if (missing.length > 5) {
                        missingHtml += '<li>...and ' + (missing.length - 5) + ' more</li>';
                    }
                    missingHtml += '</ul>';
                    document.getElementById('missingItems').innerHTML = missingHtml;
                    document.getElementById('missingItems').style.display = 'block';
                } else {
                    document.getElementById('missingItems').style.display = 'none';
                }
            } else {
                document.getElementById('missingItems').style.display = 'none';
            }
        }

        log('üöÄ Loading...');
        loadJobTypes();
        loadProjs();
        updateUI();
        log('‚úÖ Ready');
    </script>
</body>
</html>
