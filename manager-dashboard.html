<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>EMG Energy - Manager Dashboard v1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="job-types-config.js"></script>
    <script src="ai-processor.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #f5f7fa; }

        .header { background: linear-gradient(135deg, #2C5F2D 0%, #1a3a1b 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: relative; }
        .header img { height: 40px; cursor: pointer; transition: 0.3s; }
        .header img:hover { opacity: 0.8; transform: scale(1.05); }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .hamburger { cursor: pointer; display: flex; flex-direction: column; gap: 5px; padding: 5px; }
        .hamburger div { width: 25px; height: 3px; background: white; border-radius: 3px; transition: 0.3s; }
        .hamburger:hover div { background: #4CAF50; }
        .nav-menu { position: absolute; top: 70px; left: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; min-width: 200px; z-index: 1000; }
        .nav-menu.active { display: block; }
        .nav-menu a { display: block; padding: 12px 20px; color: #333; text-decoration: none; border-bottom: 1px solid #eee; transition: 0.2s; }
        .nav-menu a:last-child { border-bottom: none; }
        .nav-menu a:hover { background: #f8f9fa; color: #2C5F2D; padding-left: 25px; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .user-info { text-align: right; }
        .user-name { font-weight: bold; font-size: 18px; }
        .user-role { font-size: 12px; opacity: 0.9; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border: 1px solid white; border-radius: 6px; cursor: pointer; }

        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }

        .tabs { display: flex; gap: 10px; margin-bottom: 30px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab { padding: 15px 30px; border: none; background: none; font-size: 16px; font-weight: 600; cursor: pointer; border-radius: 8px; color: #666; transition: all 0.3s; }
        .tab.active { background: #2C5F2D; color: white; }
        .tab:hover { background: #e8f5e9; color: #2C5F2D; }
        .tab.active:hover { background: #2C5F2D; color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-num { font-size: 42px; font-weight: bold; color: #2C5F2D; margin-bottom: 10px; }
        .stat-label { color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }

        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-title { font-size: 24px; color: #2C5F2D; margin-bottom: 20px; font-weight: bold; }

        .jobs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
        .job { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 5px solid #2C5F2D; }
        .job-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .job-ref { font-size: 20px; font-weight: bold; color: #2C5F2D; }
        .job-status { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-pending { background: #FFF3CD; color: #856404; }
        .status-in-progress { background: #D1ECF1; color: #0C5460; }
        .status-completed { background: #D4EDDA; color: #155724; }
        .job-addr { color: #666; margin-bottom: 10px; }
        .job-meta { display: flex; gap: 20px; color: #999; font-size: 13px; margin-bottom: 15px; }
        .job-staff { background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .notes { background: #f9f9f9; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto; margin: 15px 0; }
        .note { padding: 8px 0; border-bottom: 1px solid #ddd; }
        .note:last-child { border-bottom: none; }
        .job-actions { display: flex; gap: 10px; margin-top: 15px; }

        button { padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #2C5F2D; color: white; }
        .btn-primary:hover { background: #1a3a1b; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-secondary:hover { background: #1976D2; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-success:hover { background: #45a049; }
        .btn-warning { background: #FF9800; color: white; }
        .btn-warning:hover { background: #F57C00; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #da190b; }
        .btn-small { padding: 8px 16px; font-size: 14px; }

        input, select, textarea { width: 100%; padding: 12px; font-size: 16px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #333; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        .empty { text-align: center; padding: 60px 20px; color: #666; }
        .empty h2 { color: #2C5F2D; margin-bottom: 15px; }

        .filter-bar { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 15px; align-items: end; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .filter-group { flex: 1; }
        .filter-group label { margin: 0 0 5px 0; font-size: 14px; }

        .login-container { max-width: 500px; margin: 100px auto; }
        .login-card { background: white; padding: 50px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
        .google-btn { display: flex; align-items: center; justify-content: center; gap: 15px; background: white; color: #333; border: 2px solid #ddd; padding: 15px 30px; font-size: 18px; width: 100%; margin-top: 20px; }
        .google-btn:hover { border-color: #2C5F2D; }

        .chart-placeholder { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); height: 300px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #2C5F2D; font-size: 24px; font-weight: bold; margin: 20px 0; }

        /* MODAL STYLES */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); overflow-y: auto; }
        .modal.active { display: block; }
        .modal-content { background: white; margin: 30px auto; max-width: 900px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; }
        .modal-header { background: linear-gradient(135deg, #2C5F2D 0%, #1a3a1b 100%); color: white; padding: 25px 30px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 24px; font-weight: bold; }
        .modal-close { background: none; border: none; color: white; font-size: 32px; cursor: pointer; padding: 0; width: 40px; height: 40px; line-height: 32px; }
        .modal-close:hover { background: rgba(255,255,255,0.2); border-radius: 50%; }
        .modal-body { padding: 30px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 20px 30px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: flex-end; }

        .detail-section { margin-bottom: 30px; }
        .detail-section h3 { color: #2C5F2D; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #e8f5e9; padding-bottom: 10px; }
        .detail-row { display: grid; grid-template-columns: 200px 1fr; gap: 15px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .detail-label { font-weight: bold; color: #666; }
        .detail-value { color: #333; }
        .detail-value input, .detail-value select, .detail-value textarea { margin: 0; }

        .note-item { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #2C5F2D; }
        .note-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .note-item-num { font-weight: bold; color: #2C5F2D; }
        .note-item-time { font-size: 12px; color: #999; }
        .note-item-text { color: #333; line-height: 1.6; }
        .note-item-text input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }

        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .photo-item { border-radius: 8px; overflow: hidden; border: 2px solid #ddd; position: relative; }
        .photo-item img { width: 100%; height: 150px; object-fit: cover; }
        .photo-item-delete { position: absolute; top: 5px; right: 5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; line-height: 28px; }

        .editable { cursor: pointer; padding: 8px; border-radius: 4px; transition: background 0.2s; }
        .editable:hover { background: #e8f5e9; }
        .editing { background: white; border: 2px solid #2C5F2D; }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" style="display: none;">
        <div class="header" style="justify-content: center;">
            <div style="text-align: center;">
                <img src="https://emgenergy.ie/wp-content/uploads/2024/05/EMG-Energy.png">
                <div style="font-size: 16px; margin-top: 10px;">Manager Dashboard</div>
            </div>
        </div>
        <div class="login-container">
            <div class="login-card">
                <h1 style="color: #2C5F2D; margin-bottom: 10px;">Welcome Back</h1>
                <p style="color: #666; margin-bottom: 30px;">Sign in to access the manager dashboard</p>

                <button class="google-btn" onclick="googleLogin()">
                    <svg width="24" height="24" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Sign in with Google
                </button>

                <div style="margin: 30px 0; color: #999;">OR</div>

                <input type="text" id="manualName" placeholder="Manager Name" style="margin-bottom: 10px;">
                <input type="password" id="manualPassword" placeholder="Password (1234)" style="margin-bottom: 10px;">
                <button class="btn-primary" onclick="manualLogin()" style="width: 100%;">Manager Login</button>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="mainDashboard" style="display: none;">
        <div class="header">
            <div class="nav-left">
                <div class="hamburger" onclick="toggleMenu()">
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                <div style="cursor: pointer;" onclick="window.location.href='index.html'">
                    <img src="https://emgenergy.ie/wp-content/uploads/2024/05/EMG-Energy.png" alt="EMG Energy" title="Go to Home">
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Manager Dashboard v1</div>
                </div>
            </div>
            <div class="nav-menu" id="navMenu">
                <a href="index.html">üè† Home</a>
                <a href="final-field.html">üìã Surveyor Mode</a>
                <a href="manager-dashboard.html">üìä Manager Dashboard</a>
            </div>
            <div class="header-right">
                <button class="btn-success" onclick="window.location.href='final-field.html'">üìã Surveyor Mode</button>
                <div class="user-info">
                    <div class="user-name" id="userName">Manager</div>
                    <div class="user-role">Administrator</div>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="container">
            <!-- STATS -->
            <div class="stats">
                <div class="stat">
                    <div class="stat-num" id="statTotal">0</div>
                    <div class="stat-label">Total Projects</div>
                </div>
                <div class="stat">
                    <div class="stat-num" id="statActive">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat">
                    <div class="stat-num" id="statCompleted">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat">
                    <div class="stat-num" id="statNotes">0</div>
                    <div class="stat-label">Voice Notes</div>
                </div>
            </div>

            <!-- TABS -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">üìä Overview</button>
                <button class="tab" onclick="switchTab('jobs')">üìã All Jobs</button>
                <button class="tab" onclick="switchTab('create')">‚ûï Create Job</button>
                <button class="tab" onclick="switchTab('jobtypes')">üîß Job Types</button>
                <button class="tab" onclick="switchTab('reports')">üìÑ Reports</button>
                <button class="tab" onclick="switchTab('analytics')">üìà Analytics</button>
            </div>

            <!-- TAB: OVERVIEW -->
            <div id="tab-overview" class="tab-content active">
                <div class="card">
                    <div class="card-title">Recent Projects</div>
                    <div id="recentJobs"></div>
                </div>
            </div>

            <!-- TAB: ALL JOBS -->
            <div id="tab-jobs" class="tab-content">
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" id="searchInput" placeholder="Reference, address..." onkeyup="filterJobs()">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filterStatus" onchange="filterJobs()">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Staff</label>
                        <select id="filterStaff" onchange="filterJobs()">
                            <option value="">All Staff</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn-secondary" onclick="clearFilters()">Clear Filters</button>
                    </div>
                </div>
                <div id="allJobsGrid" class="jobs-grid"></div>
                <div id="emptyJobs" class="empty" style="display: none;">
                    <h2>üìã No Projects Found</h2>
                    <p>Create projects in the field capture interface or use the Create Job tab.</p>
                </div>
            </div>

            <!-- TAB: CREATE JOB -->
            <div id="tab-create" class="tab-content">
                <div class="card">
                    <div class="card-title">Create New Job</div>
                    <form onsubmit="createJob(event)">
                        <div class="form-grid">
                            <div>
                                <label>Project Reference *</label>
                                <input type="text" id="newJobRef" placeholder="EMG-2026-XXXXX" required>
                            </div>
                            <div>
                                <label>Status *</label>
                                <select id="newJobStatus" required>
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>

                        <label>Address *</label>
                        <input type="text" id="newJobAddr" placeholder="Full address" required>

                        <label>Survey Type *</label>
                        <select id="newJobType" required>
                            <option value="">-- Select Survey Type --</option>
                        </select>

                        <label>Assign to Staff</label>
                        <select id="newJobStaff">
                            <option value="">-- Unassigned --</option>
                        </select>

                        <label>Notes</label>
                        <textarea id="newJobNotes" rows="4" placeholder="Additional instructions or notes..."></textarea>

                        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 18px;">Create Job</button>
                    </form>
                </div>
            </div>

            <!-- TAB: JOB TYPES -->
            <div id="tab-jobtypes" class="tab-content">
                <div class="card">
                    <div class="card-title">üîß Survey Job Types & Checklists</div>
                    <p style="color: #666; margin-bottom: 20px;">Manage survey types and their required checklist items. AI will automatically track completion as surveyors record notes.</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;" id="jobTypesGrid">
                        <!-- Job types will be loaded here -->
                    </div>

                    <div style="margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4CAF50;">
                        <h3 style="color: #2C5F2D; margin-bottom: 10px;">ü§ñ AI-Powered Checklist Tracking</h3>
                        <p style="color: #666; margin-bottom: 10px;"><strong>How it works:</strong></p>
                        <ul style="color: #666; margin-left: 20px;">
                            <li>Surveyor selects job type when creating project</li>
                            <li>As they record voice notes, AI analyzes content</li>
                            <li>Checklist items are automatically marked complete</li>
                            <li>Missing items are highlighted for surveyor</li>
                            <li>Final report includes completion status and recommendations</li>
                        </ul>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn-primary" onclick="showAddJobTypeModal()">‚ûï Create New Job Type</button>
                    </div>
                </div>
            </div>

            <!-- TAB: REPORTS -->
            <div id="tab-reports" class="tab-content">
                <div class="card">
                    <div class="card-title">Generate Reports</div>
                    <p style="color: #666; margin-bottom: 20px;">Select a project to generate a PDF report or send via email.</p>

                    <label>Select Project</label>
                    <select id="reportProject" onchange="updateReportPreview()">
                        <option value="">-- Select Project --</option>
                    </select>

                    <div id="reportPreview" style="display: none; margin-top: 30px;">
                        <h3 style="color: #2C5F2D; margin-bottom: 15px;">Report Preview</h3>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px dashed #ddd;">
                            <div id="reportContent"></div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button class="btn-primary" onclick="generatePDF()">üìÑ Generate PDF</button>
                            <button class="btn-secondary" onclick="sendEmail()">‚úâÔ∏è Send via Email</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: ANALYTICS -->
            <div id="tab-analytics" class="tab-content">
                <div class="card">
                    <div class="card-title">Work Analytics</div>

                    <div class="chart-placeholder">
                        üìä Projects by Status
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                        <div class="card" style="margin: 0;">
                            <h3 style="color: #2C5F2D; margin-bottom: 15px;">Staff Performance</h3>
                            <div id="staffStats"></div>
                        </div>
                        <div class="card" style="margin: 0;">
                            <h3 style="color: #2C5F2D; margin-bottom: 15px;">Recent Activity</h3>
                            <div id="recentActivity"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JOB DETAILS MODAL -->
    <div id="jobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Job Details</div>
                <button class="modal-close" onclick="closeJobModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Project Details -->
                <div class="detail-section">
                    <h3>üìã Project Information</h3>
                    <div class="detail-row">
                        <div class="detail-label">Project Reference:</div>
                        <div class="detail-value">
                            <input type="text" id="edit-ref" readonly style="background: #f8f9fa;">
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Address:</div>
                        <div class="detail-value">
                            <input type="text" id="edit-address">
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status:</div>
                        <div class="detail-value">
                            <select id="edit-status">
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Assigned To:</div>
                        <div class="detail-value">
                            <select id="edit-staff">
                                <option value="">Unassigned</option>
                            </select>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Created:</div>
                        <div class="detail-value" id="edit-created">-</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Created By:</div>
                        <div class="detail-value" id="edit-createdby">-</div>
                    </div>
                </div>

                <!-- Voice Notes -->
                <div class="detail-section">
                    <h3>üé§ Voice Notes (<span id="notes-count">0</span>)</h3>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">Raw survey transcriptions (edit if needed):</p>
                    <div id="modal-notes"></div>
                    <div style="text-align: center; color: #999; padding: 20px;" id="no-notes" style="display: none;">
                        No voice notes recorded
                    </div>
                </div>

                <!-- AI-Generated Professional Text -->
                <div class="detail-section">
                    <h3>ü§ñ AI-Generated Professional Report Text</h3>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0 15px 0;">
                        <strong>Review and edit:</strong> This is the professional BER assessment text that will appear in the final PDF report.
                        The AI has transformed the voice notes above into professional technical language. Edit as needed before approval.
                    </p>
                    <div id="ai-professional-text-container" style="max-height: 400px; overflow-y: auto;">
                        <!-- Will be populated with AI-generated professional text -->
                    </div>
                    <div style="text-align: center; color: #999; padding: 20px;" id="no-ai-text">
                        No voice notes to process
                    </div>
                </div>

                <!-- Photos -->
                <div class="detail-section">
                    <h3>üì∑ Photos (<span id="photos-count">0</span>)</h3>
                    <div id="modal-photos" class="photo-grid"></div>
                    <div style="text-align: center; color: #999; padding: 20px;" id="no-photos">
                        No photos uploaded
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="detail-section">
                    <h3>üí° Professional Recommendations</h3>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0 10px 0;">
                        <strong>Automatically generated</strong> based on survey data, photos, and BER analysis. Edit as needed before finalizing report.
                    </p>
                    <textarea id="edit-ai-recommendations" rows="8" placeholder="Recommendations will auto-generate based on survey data..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; line-height: 1.6;"></textarea>
                </div>

                <!-- Manager Notes -->
                <div class="detail-section">
                    <h3>üìù Manager Notes</h3>
                    <textarea id="edit-manager-notes" rows="4" placeholder="Add manager notes or instructions..."></textarea>
                    <button onclick="saveManagerNotes()" style="margin-top: 10px; padding: 8px 15px; background: #2c5f2d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        üíæ Save Manager Notes
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="generateJobPDF(STATE.currentJob.jobId)">üìÑ Download PDF</button>
                <button class="btn-secondary" onclick="printJobPDF(STATE.currentJob.jobId)">üñ®Ô∏è Print</button>
                <button class="btn-secondary" onclick="emailJob(STATE.currentJob.jobId)">‚úâÔ∏è Email Manager</button>
                <button class="btn-success" onclick="saveJobChanges()">üíæ Save Changes</button>
                <button class="btn-success" onclick="approveAndFinalizeReport()" style="background: #2c5f2d;">‚úÖ Approve & Finalize Report</button>
                <button class="btn-warning" onclick="closeJobModal()">Cancel</button>
                <button class="btn-danger" onclick="deleteJobFromModal()">üóëÔ∏è Delete</button>
            </div>
        </div>
    </div>

    <script>
        var STATE = {
            user: null,
            jobs: [],
            staffList: ['John Murphy', 'Sarah O\'Brien', 'Michael Kelly', 'Emma Walsh'],
            currentJob: null
        };

        function log(m) { console.log('[DASHBOARD] ' + m); }

        // ============= AUTHENTICATION =============
        function init() {
            log('üöÄ Initializing dashboard...');
            var user = localStorage.getItem('emg_user');
            if (user) {
                STATE.user = JSON.parse(user);
                showDashboard();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainDashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
            document.getElementById('userName').textContent = STATE.user.name;
            loadData();
        }

        function googleLogin() {
            // Simulate Google OAuth (in production, use real OAuth)
            var name = prompt('Google Sign-In (Demo)\nEnter your name:');
            if (!name) return;

            STATE.user = {
                name: name,
                email: name.toLowerCase().replace(/\s+/g, '.') + '@emgenergy.ie',
                loginMethod: 'google',
                loginTime: new Date().toISOString()
            };
            localStorage.setItem('emg_user', JSON.stringify(STATE.user));
            log('‚úÖ Google login: ' + STATE.user.name);
            showDashboard();
        }

        function manualLogin() {
            var name = document.getElementById('manualName').value.trim();
            var password = document.getElementById('manualPassword').value;

            if (!name) {
                alert('‚ùå Please enter your name');
                return;
            }

            if (password !== '1234') {
                alert('‚ùå Incorrect Password\n\nManager access requires password 1234');
                return;
            }

            STATE.user = {
                name: name,
                email: name.toLowerCase().replace(/\s+/g, '.') + '@emgenergy.ie',
                loginMethod: 'manual',
                loginTime: new Date().toISOString()
            };
            localStorage.setItem('emg_user', JSON.stringify(STATE.user));
            log('‚úÖ Manager login: ' + STATE.user.name);
            showDashboard();
        }

        function logout() {
            if (!confirm('Are you sure you want to logout?')) return;
            localStorage.removeItem('emg_user');
            STATE.user = null;
            log('üëã Logged out');
            showLogin();
        }

        function toggleMenu() {
            var menu = document.getElementById('navMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            var menu = document.getElementById('navMenu');
            var hamburger = event.target.closest('.hamburger');
            if (menu && !hamburger && !event.target.closest('.nav-menu')) {
                menu.classList.remove('active');
            }
        });

        // ============= DATA LOADING =============
        function loadData() {
            log('üìÇ Loading jobs...');
            try {
                var data = localStorage.getItem('emg_all_jobs');
                STATE.jobs = data ? JSON.parse(data) : [];
                log('‚úÖ Loaded ' + STATE.jobs.length + ' jobs');
            } catch(e) {
                log('‚ùå Load error: ' + e.message);
                STATE.jobs = [];
            }
            updateStats();
            displayOverview();
            displayAllJobs();
            populateDropdowns();
        }

        function updateStats() {
            var total = STATE.jobs.length;
            var active = 0;
            var completed = 0;
            var notes = 0;

            for (var i = 0; i < STATE.jobs.length; i++) {
                if (STATE.jobs[i].status === 'in-progress') active++;
                if (STATE.jobs[i].status === 'completed') completed++;
                notes += (STATE.jobs[i].voiceNotes || []).length;
            }

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statActive').textContent = active;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statNotes').textContent = notes;
        }

        // ============= TABS =============
        function switchTab(tabName) {
            // Update tab buttons
            var tabs = document.querySelectorAll('.tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            event.target.classList.add('active');

            // Update tab content
            var contents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            document.getElementById('tab-' + tabName).classList.add('active');

            log('üìë Switched to tab: ' + tabName);
        }

        // ============= OVERVIEW TAB =============
        function displayOverview() {
            var container = document.getElementById('recentJobs');

            if (STATE.jobs.length === 0) {
                container.innerHTML = '<div class="empty"><h2>üìã No Projects Yet</h2><p>Create projects using Surveyor Mode or the Create Job tab.</p></div>';
                return;
            }

            // Show last 5 jobs
            var recent = STATE.jobs.slice(-5).reverse();
            var html = '<div class="jobs-grid">';

            for (var i = 0; i < recent.length; i++) {
                html += renderJobCard(recent[i]);
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // ============= ALL JOBS TAB =============
        function displayAllJobs() {
            var filtered = getFilteredJobs();
            var container = document.getElementById('allJobsGrid');
            var empty = document.getElementById('emptyJobs');

            if (filtered.length === 0) {
                container.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            empty.style.display = 'none';

            var html = '';
            for (var i = 0; i < filtered.length; i++) {
                html += renderJobCard(filtered[i]);
            }
            container.innerHTML = html;
        }

        function renderJobCard(job) {
            var statusClass = 'status-' + job.status;
            var statusLabel = job.status.replace('-', ' ').toUpperCase();

            var notesHtml = '';
            if (job.voiceNotes && job.voiceNotes.length > 0) {
                notesHtml = '<div class="notes"><strong>Voice Notes (' + job.voiceNotes.length + '):</strong>';
                for (var i = 0; i < job.voiceNotes.length; i++) {
                    notesHtml += '<div class="note">' + (i+1) + '. ' + job.voiceNotes[i].transcription + '</div>';
                }
                notesHtml += '</div>';
            }

            var staffHtml = job.assignedTo ? '<div class="job-staff">üë§ Assigned to: <strong>' + job.assignedTo + '</strong></div>' : '';

            return '<div class="job">' +
                '<div class="job-header">' +
                    '<div class="job-ref">' + job.projectReference + '</div>' +
                    '<div class="job-status ' + statusClass + '">' + statusLabel + '</div>' +
                '</div>' +
                '<div class="job-addr">üìç ' + job.address + '</div>' +
                '<div class="job-meta">' +
                    '<span>üé§ ' + (job.voiceNotes || []).length + ' notes</span>' +
                    '<span>üìÖ ' + new Date(job.createdAt).toLocaleDateString() + '</span>' +
                '</div>' +
                staffHtml +
                notesHtml +
                '<div class="job-actions">' +
                    '<button class="btn-primary btn-small" onclick="viewJobDetails(\'' + job.jobId + '\')">üìã View/Edit</button>' +
                    '<button class="btn-secondary btn-small" onclick="generateJobPDF(\'' + job.jobId + '\')">üìÑ PDF</button>' +
                    '<button class="btn-success btn-small" onclick="printJobPDF(\'' + job.jobId + '\')">üñ®Ô∏è Print</button>' +
                    '<button class="btn-warning btn-small" onclick="emailJob(\'' + job.jobId + '\')">‚úâÔ∏è Email</button>' +
                    '<button class="btn-danger btn-small" onclick="deleteJob(\'' + job.jobId + '\')">üóëÔ∏è Delete</button>' +
                '</div>' +
            '</div>';
        }

        function getFilteredJobs() {
            var search = document.getElementById('searchInput').value.toLowerCase();
            var status = document.getElementById('filterStatus').value;
            var staff = document.getElementById('filterStaff').value;

            return STATE.jobs.filter(function(job) {
                var matchSearch = !search ||
                    job.projectReference.toLowerCase().includes(search) ||
                    job.address.toLowerCase().includes(search);
                var matchStatus = !status || job.status === status;
                var matchStaff = !staff || job.assignedTo === staff;
                return matchSearch && matchStatus && matchStaff;
            });
        }

        function filterJobs() {
            displayAllJobs();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterStaff').value = '';
            filterJobs();
        }

        // ============= CREATE JOB TAB =============
        function createJob(e) {
            e.preventDefault();

            var job = {
                jobId: 'job-' + Date.now(),
                projectReference: document.getElementById('newJobRef').value.trim(),
                address: document.getElementById('newJobAddr').value.trim(),
                jobTypeId: document.getElementById('newJobType').value,
                status: document.getElementById('newJobStatus').value,
                assignedTo: document.getElementById('newJobStaff').value || null,
                createdAt: new Date().toISOString(),
                createdBy: STATE.user.name,
                voiceNotes: [],
                photos: [],
                checkedItems: {},
                managerInputs: {
                    notes: document.getElementById('newJobNotes').value.trim()
                }
            };

            STATE.jobs.push(job);
            localStorage.setItem('emg_all_jobs', JSON.stringify(STATE.jobs));

            log('‚úÖ Created job: ' + job.projectReference);
            alert('‚úÖ Job created successfully!');

            // Reset form
            document.getElementById('newJobRef').value = '';
            document.getElementById('newJobAddr').value = '';
            document.getElementById('newJobNotes').value = '';

            // Refresh data
            loadData();
            switchTab('jobs');
        }

        // ============= REPORTS TAB =============
        function populateDropdowns() {
            // Populate report project dropdown
            var reportSel = document.getElementById('reportProject');
            reportSel.innerHTML = '<option value="">-- Select Project --</option>';
            for (var i = 0; i < STATE.jobs.length; i++) {
                var opt = document.createElement('option');
                opt.value = STATE.jobs[i].jobId;
                opt.textContent = STATE.jobs[i].projectReference + ' - ' + STATE.jobs[i].address;
                reportSel.appendChild(opt);
            }

            // Populate staff dropdowns
            var staffDropdowns = ['newJobStaff', 'filterStaff'];
            for (var i = 0; i < staffDropdowns.length; i++) {
                var sel = document.getElementById(staffDropdowns[i]);
                for (var j = 0; j < STATE.staffList.length; j++) {
                    var opt = document.createElement('option');
                    opt.value = STATE.staffList[j];
                    opt.textContent = STATE.staffList[j];
                    sel.appendChild(opt);
                }
            }

            // Populate job type dropdown
            var jobTypes = getJobTypes();
            var jobTypeSel = document.getElementById('newJobType');
            if (jobTypeSel) {
                for (var key in jobTypes) {
                    if (jobTypes.hasOwnProperty(key)) {
                        var opt = document.createElement('option');
                        opt.value = key;
                        opt.textContent = jobTypes[key].icon + ' ' + jobTypes[key].name;
                        jobTypeSel.appendChild(opt);
                    }
                }
            }
        }

        function updateReportPreview() {
            var jobId = document.getElementById('reportProject').value;
            var preview = document.getElementById('reportPreview');

            if (!jobId) {
                preview.style.display = 'none';
                return;
            }

            var job = STATE.jobs.find(function(j) { return j.jobId === jobId; });
            if (!job) return;

            var html = '<h2 style="color: #2C5F2D; margin-bottom: 10px;">EMG Energy Assessment Report</h2>' +
                '<p><strong>Reference:</strong> ' + job.projectReference + '</p>' +
                '<p><strong>Address:</strong> ' + job.address + '</p>' +
                '<p><strong>Date:</strong> ' + new Date(job.createdAt).toLocaleDateString() + '</p>' +
                '<p><strong>Status:</strong> ' + job.status.toUpperCase() + '</p>';

            if (job.assignedTo) {
                html += '<p><strong>Field Officer:</strong> ' + job.assignedTo + '</p>';
            }

            if (job.voiceNotes && job.voiceNotes.length > 0) {
                html += '<h3 style="margin-top: 20px; color: #2C5F2D;">Field Notes:</h3><ol>';
                for (var i = 0; i < job.voiceNotes.length; i++) {
                    html += '<li style="margin: 5px 0;">' + job.voiceNotes[i].transcription + '</li>';
                }
                html += '</ol>';
            }

            document.getElementById('reportContent').innerHTML = html;
            preview.style.display = 'block';
        }

        function generatePDF() {
            var jobId = document.getElementById('reportProject').value;
            if (!jobId) {
                alert('‚ùå Select a project first');
                return;
            }

            var job = STATE.jobs.find(function(j) { return j.jobId === jobId; });
            generateJobPDF(job.jobId);
        }

        function generateJobPDF(jobId) {
            var job = STATE.jobs.find(function(j) { return j.jobId === jobId; });
            if (!job) return;

            try {
                var { jsPDF } = window.jspdf;
                var doc = new jsPDF();
                var pageWidth = doc.internal.pageSize.getWidth();
                var pageHeight = doc.internal.pageSize.getHeight();

                // ========== COVER PAGE ==========
                // Green header box with logo
                doc.setFillColor(44, 95, 45);
                doc.rect(0, 0, pageWidth, 70, 'F');

                // EMG Energy logo - white box with text
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(pageWidth / 2 - 40, 10, 80, 20, 3, 3, 'F');
                doc.setTextColor(44, 95, 45);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('EMG ENERGY', pageWidth / 2, 22, { align: 'center' });

                // Title on cover
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(26);
                doc.setFont(undefined, 'bold');
                doc.text('BUILDING ENERGY', pageWidth / 2, 42, { align: 'center' });
                doc.text('ASSESSMENT REPORT', pageWidth / 2, 52, { align: 'center' });

                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text('Irish Building Regulations Part L Compliance Survey', pageWidth / 2, 62, { align: 'center' });

                // Property details box
                doc.setTextColor(0, 0, 0);
                doc.setFillColor(248, 249, 250);
                doc.roundedRect(20, 85, pageWidth - 40, 50, 3, 3, 'F');

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Property Address:', 30, 100);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(12);
                var addressLines = doc.splitTextToSize(job.address, pageWidth - 60);
                doc.text(addressLines, 30, 110);

                // Report details
                var detailY = 150;
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Report Reference:', 30, detailY);
                doc.setFont(undefined, 'normal');
                doc.text(job.projectReference, 100, detailY);
                detailY += 8;

                doc.setFont(undefined, 'bold');
                doc.text('Survey Date:', 30, detailY);
                doc.setFont(undefined, 'normal');
                doc.text(new Date(job.createdAt).toLocaleDateString('en-IE', { day: 'numeric', month: 'long', year: 'numeric' }), 100, detailY);
                detailY += 8;

                doc.setFont(undefined, 'bold');
                doc.text('Assessor:', 30, detailY);
                doc.setFont(undefined, 'normal');
                doc.text(job.assignedTo || 'EMG Energy Surveyor', 100, detailY);
                detailY += 8;

                doc.setFont(undefined, 'bold');
                doc.text('Assessment Status:', 30, detailY);
                doc.setFont(undefined, 'normal');
                doc.text(job.status.toUpperCase().replace('-', ' '), 100, detailY);

                // Company branding box at bottom of cover
                doc.setFillColor(44, 95, 45);
                doc.roundedRect(20, 220, pageWidth - 40, 8, 2, 2, 'F');

                doc.setFontSize(14);
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.text('EMG ENERGY CONSULTANTS', pageWidth / 2, 226, { align: 'center' });

                doc.setFontSize(9);
                doc.setTextColor(80, 80, 80);
                doc.setFont(undefined, 'normal');
                doc.text('Suite 17, Block A, Clare Technology Park', pageWidth / 2, 240, { align: 'center' });
                doc.text('Gort Road, Ennis, Co. Clare, Ireland', pageWidth / 2, 247, { align: 'center' });
                doc.text('Tel: 065 672 9090 | Mobile: 087 944 4470', pageWidth / 2, 254, { align: 'center' });
                doc.text('Email: info@emgenergy.ie | Web: www.emgenergy.ie', pageWidth / 2, 261, { align: 'center' });

                // ========== PAGE 2: EXECUTIVE SUMMARY ==========
                doc.addPage();
                var y = 20;

                // Page header
                doc.setFillColor(44, 95, 45);
                doc.rect(0, 0, pageWidth, 15, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });

                doc.setTextColor(0, 0, 0);
                y = 30;

                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(44, 95, 45);
                doc.text('EXECUTIVE SUMMARY', 20, y);
                y += 10;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                var summary = 'This report presents the findings of a comprehensive building energy assessment ' +
                    'conducted at the above property in accordance with Irish Building Regulations Part L. ' +
                    'The survey was performed by a qualified EMG Energy assessor using professional survey ' +
                    'equipment and methodologies compliant with TGD L 2022 standards.';
                var summaryLines = doc.splitTextToSize(summary, pageWidth - 40);
                doc.text(summaryLines, 20, y);
                y += summaryLines.length * 5 + 10;

                // Survey scope
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(44, 95, 45);
                doc.text('Survey Scope', 20, y);
                y += 8;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                var scope = [
                    '‚Ä¢ Thermal envelope assessment (walls, roof, floors, windows, doors)',
                    '‚Ä¢ Space heating and hot water systems evaluation',
                    '‚Ä¢ Ventilation systems inspection',
                    '‚Ä¢ Building fabric thermal bridging assessment',
                    '‚Ä¢ Air tightness and draught proofing evaluation',
                    '‚Ä¢ Renewable energy systems (if present)',
                    '‚Ä¢ Energy efficiency opportunities identification'
                ];
                for (var i = 0; i < scope.length; i++) {
                    doc.text(scope[i], 25, y);
                    y += 6;
                }
                y += 5;

                // Survey methodology
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(44, 95, 45);
                doc.text('Methodology', 20, y);
                y += 8;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                var method = 'The assessment was conducted using a systematic room-by-room survey approach. ' +
                    'All accessible areas were inspected and measurements were recorded using calibrated ' +
                    'equipment. Data collection followed the DEAP (Dwelling Energy Assessment Procedure) ' +
                    'methodology as specified in TGD L 2022.';
                var methodLines = doc.splitTextToSize(method, pageWidth - 40);
                doc.text(methodLines, 20, y);
                y += methodLines.length * 5 + 10;

                // Key findings
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(44, 95, 45);
                doc.text('Key Findings', 20, y);
                y += 8;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                var findings = 'Detailed observations from ' + (job.voiceNotes ? job.voiceNotes.length : 0) +
                    ' survey points have been recorded across all accessible areas of the property. ' +
                    'Survey data includes thermal performance indicators, equipment specifications, ' +
                    'and compliance assessment against current building regulations.';
                var findingsLines = doc.splitTextToSize(findings, pageWidth - 40);
                doc.text(findingsLines, 20, y);

                // ========== PAGE 3+: SURVEY OBSERVATIONS ==========
                doc.addPage();
                y = 30;

                // Page header
                doc.setFillColor(44, 95, 45);
                doc.rect(0, 0, pageWidth, 15, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });

                doc.setTextColor(0, 0, 0);

                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(44, 95, 45);
                doc.text('SURVEY OBSERVATIONS & TECHNICAL DATA', 20, y);
                y += 12;

                // Parse and organize voice notes
                if (job.voiceNotes && job.voiceNotes.length > 0) {
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');

                    for (var i = 0; i < job.voiceNotes.length; i++) {
                        if (y > 260) {
                            doc.addPage();
                            // Repeat header on new pages
                            doc.setFillColor(44, 95, 45);
                            doc.rect(0, 0, pageWidth, 15, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });
                            doc.setTextColor(0, 0, 0);
                            y = 30;
                        }

                        // Observation box
                        doc.setFillColor(248, 249, 250);
                        var boxHeight = 20; // Estimate, will adjust
                        doc.roundedRect(20, y - 5, pageWidth - 40, boxHeight, 2, 2, 'F');

                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(44, 95, 45);
                        doc.text('Observation ' + (i + 1) + ':', 25, y);
                        doc.setTextColor(100, 100, 100);
                        doc.setFontSize(8);
                        doc.text(new Date(job.voiceNotes[i].captured_at).toLocaleString('en-IE'), pageWidth - 25, y, { align: 'right' });

                        y += 7;
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'normal');

                        // Use manager-approved professional text if available, otherwise AI-generate
                        var professionalText = '';
                        if (job.managerInputs && job.managerInputs.professionalTexts && job.managerInputs.professionalTexts[job.voiceNotes[i].id]) {
                            // Manager has reviewed and approved this text
                            professionalText = job.managerInputs.professionalTexts[job.voiceNotes[i].id];
                        } else {
                            // AI-process voice note into professional BER assessment text
                            professionalText = AI_PROCESSOR.professionalize(job.voiceNotes[i].transcription);
                        }
                        var noteLines = doc.splitTextToSize(professionalText, pageWidth - 50);
                        doc.text(noteLines, 25, y);
                        y += noteLines.length * 5 + 8;
                    }
                }

                // ========== CHECKLIST COMPLETION (if job type exists) ==========
                if (job.jobTypeId && job.checkedItems) {
                    if (y > 200) {
                        doc.addPage();
                        doc.setFillColor(44, 95, 45);
                        doc.rect(0, 0, pageWidth, 15, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });
                        doc.setTextColor(0, 0, 0);
                        y = 30;
                    } else {
                        y += 15;
                    }

                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(44, 95, 45);
                    doc.text('SURVEY COMPLETION STATUS', 20, y);
                    y += 10;

                    // Run AI analysis
                    var aiAnalysis = AI_PROCESSOR.analyzeProject(job);
                    var completionPct = aiAnalysis.completionPercentage;

                    // Completion bar
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    doc.text('Overall Completion:', 20, y);
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(18);
                    doc.setTextColor(completionPct >= 80 ? 76 : 255, completionPct >= 80 ? 175 : 152, completionPct >= 80 ? 80 : 0);
                    doc.text(completionPct + '%', 80, y);
                    y += 5;

                    // Progress bar
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.rect(20, y, pageWidth - 40, 8);
                    doc.setFillColor(completionPct >= 80 ? 76 : 255, completionPct >= 80 ? 175 : 152, completionPct >= 80 ? 80 : 0);
                    doc.rect(20, y, (pageWidth - 40) * (completionPct / 100), 8, 'F');
                    y += 15;

                    // Checklist summary by category
                    var jobType = getJobType(job.jobTypeId);
                    if (jobType && jobType.checklist) {
                        doc.setFontSize(11);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'bold');
                        doc.text('Checklist Summary:', 20, y);
                        y += 8;

                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);

                        for (var i = 0; i < jobType.checklist.length; i++) {
                            if (y > 270) {
                                doc.addPage();
                                doc.setFillColor(44, 95, 45);
                                doc.rect(0, 0, pageWidth, 15, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(10);
                                doc.setFont(undefined, 'bold');
                                doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });
                                doc.setTextColor(0, 0, 0);
                                y = 30;
                            }

                            var category = jobType.checklist[i];
                            var categoryChecked = 0;
                            for (var j = 0; j < category.items.length; j++) {
                                if (aiAnalysis.checkedItems[category.items[j].id]) {
                                    categoryChecked++;
                                }
                            }
                            var categoryPct = Math.round((categoryChecked / category.items.length) * 100);
                            var statusIcon = categoryPct === 100 ? '‚úì' : categoryPct >= 50 ? '‚óê' : '‚óã';

                            doc.setTextColor(categoryPct === 100 ? 76 : 100, categoryPct === 100 ? 175 : 100, categoryPct === 100 ? 80 : 100);
                            doc.text(statusIcon + ' ' + category.category + ': ' + categoryChecked + '/' + category.items.length + ' (' + categoryPct + '%)', 25, y);
                            y += 6;
                        }
                        y += 5;
                    }

                    // Outstanding items
                    if (aiAnalysis.suggestions && aiAnalysis.suggestions.length > 0) {
                        if (y > 240) {
                            doc.addPage();
                            doc.setFillColor(44, 95, 45);
                            doc.rect(0, 0, pageWidth, 15, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });
                            doc.setTextColor(0, 0, 0);
                            y = 30;
                        }

                        y += 5;
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(255, 152, 0);
                        doc.text('‚ö† OUTSTANDING SURVEY ITEMS', 20, y);
                        y += 8;

                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'normal');

                        for (var i = 0; i < Math.min(aiAnalysis.suggestions.length, 3); i++) {
                            var suggestion = aiAnalysis.suggestions[i];
                            if (y > 260) break; // Don't overflow page

                            doc.setFont(undefined, 'bold');
                            doc.text(suggestion.category + ':', 25, y);
                            y += 5;
                            doc.setFont(undefined, 'normal');

                            for (var j = 0; j < Math.min(suggestion.items.length, 3); j++) {
                                if (y > 270) break;
                                doc.text('‚Ä¢ ' + suggestion.items[j], 30, y);
                                y += 5;
                            }
                            if (suggestion.items.length > 3) {
                                doc.text('‚Ä¢ ...and ' + (suggestion.items.length - 3) + ' more items', 30, y);
                                y += 5;
                            }
                            y += 3;
                        }
                    }
                }

                // ========== PHOTOS SECTION ==========
                if (job.photos && job.photos.length > 0) {
                    doc.addPage();
                    doc.setFillColor(44, 95, 45);
                    doc.rect(0, 0, pageWidth, 15, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });
                    y = 30;

                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(44, 95, 45);
                    doc.text('SITE PHOTOGRAPHS', 20, y);
                    y += 10;

                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    doc.text('Equipment screens, clipboard data, and site condition photographs', 20, y);
                    y += 15;

                    // Display photos (max 6 photos to prevent file size issues)
                    for (var i = 0; i < Math.min(job.photos.length, 6); i++) {
                        if (y > 200) {
                            doc.addPage();
                            doc.setFillColor(44, 95, 45);
                            doc.rect(0, 0, pageWidth, 15, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });
                            doc.setTextColor(0, 0, 0);
                            y = 30;
                        }

                        try {
                            doc.setFontSize(9);
                            doc.setTextColor(100, 100, 100);
                            doc.text('Photo ' + (i + 1) + ' - ' + new Date(job.photos[i].timestamp).toLocaleString('en-IE'), 20, y);
                            y += 5;

                            // Add image (scaled to fit)
                            var imgWidth = pageWidth - 40;
                            var imgHeight = 60; // Fixed height
                            doc.addImage(job.photos[i].data, 'JPEG', 20, y, imgWidth, imgHeight);
                            y += imgHeight + 15;
                        } catch(imgErr) {
                            doc.setTextColor(150, 150, 150);
                            doc.text('[Photo ' + (i + 1) + ' - Unable to embed]', 20, y);
                            y += 10;
                        }
                    }

                    if (job.photos.length > 6) {
                        doc.setFontSize(9);
                        doc.setTextColor(100, 100, 100);
                        doc.text('+ ' + (job.photos.length - 6) + ' additional photos not shown', 20, y);
                    }
                }

                // ========== COMPLIANCE SECTION ==========
                if (y > 220) {
                    doc.addPage();
                    doc.setFillColor(44, 95, 45);
                    doc.rect(0, 0, pageWidth, 15, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });
                    doc.setTextColor(0, 0, 0);
                    y = 30;
                } else {
                    y += 10;
                }

                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(44, 95, 45);
                doc.text('REGULATORY COMPLIANCE', 20, y);
                y += 10;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                var compliance = 'This assessment has been conducted in accordance with:\n\n' +
                    '‚Ä¢ Building Regulations 1997-2023 (Part L: Conservation of Fuel and Energy)\n' +
                    '‚Ä¢ Technical Guidance Document L (TGD L 2022)\n' +
                    '‚Ä¢ Dwelling Energy Assessment Procedure (DEAP) methodology\n' +
                    '‚Ä¢ I.S. EN ISO 13790: Energy performance of buildings\n' +
                    '‚Ä¢ I.S. 399: Code of Practice for Energy Efficiency in Buildings';
                var complianceLines = doc.splitTextToSize(compliance, pageWidth - 40);
                doc.text(complianceLines, 20, y);
                y += complianceLines.length * 5 + 10;

                // Professional Recommendations section
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(44, 95, 45);
                doc.text('PROFESSIONAL RECOMMENDATIONS', 20, y);
                y += 10;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');

                // Use AI-generated recommendations if available, otherwise use default
                if (job.managerInputs && job.managerInputs.recommendations) {
                    var aiRecommendations = job.managerInputs.recommendations;
                    var recLines = aiRecommendations.split('\n');

                    for (var i = 0; i < recLines.length; i++) {
                        if (y > 270) {
                            doc.addPage();
                            doc.setFillColor(44, 95, 45);
                            doc.rect(0, 0, pageWidth, 15, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });
                            doc.setTextColor(0, 0, 0);
                            y = 30;
                        }

                        var line = recLines[i];

                        // Format section headers (lines with = or all caps)
                        if (line.indexOf('‚ïê‚ïê‚ïê') !== -1) {
                            continue; // Skip separator lines
                        } else if (line === line.toUpperCase() && line.trim().length > 0 && line.trim().length < 50) {
                            // Section header
                            y += 3;
                            doc.setFont(undefined, 'bold');
                            doc.setTextColor(44, 95, 45);
                            doc.setFontSize(11);
                            var headerLines = doc.splitTextToSize(line, pageWidth - 40);
                            doc.text(headerLines, 20, y);
                            y += headerLines.length * 5 + 3;
                            doc.setFont(undefined, 'normal');
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(10);
                        } else if (line.trim().length > 0) {
                            // Regular line
                            var textLines = doc.splitTextToSize(line, pageWidth - 45);
                            doc.text(textLines, 25, y);
                            y += textLines.length * 5;
                        } else {
                            // Empty line
                            y += 3;
                        }
                    }
                } else {
                    // Default recommendations if no AI recommendations
                    var recommendations = [
                        '‚Ä¢ Detailed energy performance calculations to be completed using DEAP software',
                        '‚Ä¢ Air tightness testing recommended to verify building envelope performance',
                        '‚Ä¢ Thermal imaging survey to identify thermal bridges and heat loss areas',
                        '‚Ä¢ Review of heating controls and thermostat settings for optimization',
                        '‚Ä¢ Assessment of renewable energy integration opportunities',
                        '‚Ä¢ Evaluation of upgrade paths to achieve higher BER ratings'
                    ];
                    for (var i = 0; i < recommendations.length; i++) {
                        if (y > 270) {
                            doc.addPage();
                            doc.setFillColor(44, 95, 45);
                            doc.rect(0, 0, pageWidth, 15, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });
                            doc.setTextColor(0, 0, 0);
                            y = 30;
                        }
                        doc.text(recommendations[i], 25, y);
                        y += 6;
                    }
                }

                // Manager notes if present
                if (job.managerInputs && job.managerInputs.notes) {
                    y += 10;
                    if (y > 250) {
                        doc.addPage();
                        doc.setFillColor(44, 95, 45);
                        doc.rect(0, 0, pageWidth, 15, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        doc.text('BUILDING ENERGY ASSESSMENT REPORT', pageWidth / 2, 10, { align: 'center' });
                        doc.setTextColor(0, 0, 0);
                        y = 30;
                    }

                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(44, 95, 45);
                    doc.text('ADDITIONAL NOTES', 20, y);
                    y += 8;

                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    var managerLines = doc.splitTextToSize(job.managerInputs.notes, pageWidth - 40);
                    doc.text(managerLines, 20, y);
                }

                // Add footer to all pages
                var pageCount = doc.internal.getNumberOfPages();
                for (var i = 1; i <= pageCount; i++) {
                    doc.setPage(i);

                    // Footer line
                    doc.setDrawColor(44, 95, 45);
                    doc.setLineWidth(0.5);
                    doc.line(20, pageHeight - 20, pageWidth - 20, pageHeight - 20);

                    // Footer text
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.setFont(undefined, 'normal');
                    doc.text('EMG Energy Consultants | Suite 17, Block A, Clare Technology Park, Ennis, Co. Clare', pageWidth / 2, pageHeight - 15, { align: 'center' });
                    doc.text('Tel: 065 672 9090 | Email: info@emgenergy.ie | Web: www.emgenergy.ie', pageWidth / 2, pageHeight - 10, { align: 'center' });

                    doc.setFontSize(9);
                    doc.setTextColor(44, 95, 45);
                    doc.setFont(undefined, 'bold');
                    doc.text('Page ' + i + ' of ' + pageCount, pageWidth - 20, pageHeight - 15, { align: 'right' });
                    doc.text(job.projectReference, 20, pageHeight - 15);
                }

                // Save PDF
                var fileName = job.projectReference.replace(/[^a-z0-9]/gi, '_') + '_BER_Assessment_Report.pdf';
                doc.save(fileName);

                log('‚úÖ Professional BER Report downloaded: ' + fileName);
                var reportFeatures = '‚Ä¢ Professional cover page with EMG branding\n' +
                      '‚Ä¢ Executive summary\n' +
                      '‚Ä¢ AI-analyzed survey observations\n';

                if (job.jobTypeId && job.checkedItems) {
                    reportFeatures += '‚Ä¢ Checklist completion status (' + aiAnalysis.completionPercentage + '%)\n';
                    if (aiAnalysis.suggestions && aiAnalysis.suggestions.length > 0) {
                        reportFeatures += '‚Ä¢ Outstanding items identified\n';
                    }
                }

                if (job.photos && job.photos.length > 0) {
                    reportFeatures += '‚Ä¢ Site photographs (' + Math.min(job.photos.length, 6) + ' photos)\n';
                }

                reportFeatures += '‚Ä¢ Regulatory compliance statements\n' +
                      '‚Ä¢ Professional recommendations\n' +
                      '‚Ä¢ Full technical specifications';

                alert('‚úÖ Professional BER Report Generated!\n\n' +
                      'File: ' + fileName + '\n\n' +
                      'Report includes:\n' + reportFeatures + '\n\n' +
                      'Check your Downloads folder.');

            } catch(err) {
                log('‚ùå PDF Error: ' + err.message);
                alert('‚ùå PDF Generation Error\n\n' + err.message + '\n\nPlease try again or contact support.');
            }
        }

        function printJobPDF(jobId) {
            // Print now uses same PDF as download - just opens print dialog instead
            log('üñ®Ô∏è Opening PDF for printing...');
            alert('üìÑ Print Function\n\nThe Print button now generates the same professional PDF.\n\nYour PDF will download - then use your browser\'s print function (Ctrl+P) to print it.');
            generateJobPDF(jobId);
        }

        function sendEmail() {
            var jobId = document.getElementById('reportProject').value;
            if (!jobId) {
                alert('‚ùå Select a project first');
                return;
            }

            var job = STATE.jobs.find(function(j) { return j.jobId === jobId; });
            var recipient = prompt('Enter recipient email address:');
            if (!recipient) return;

            // Create mailto link
            var subject = 'EMG Energy Report - ' + job.projectReference;
            var body = 'Dear Sir/Madam,\n\nPlease find attached the building assessment report for:\n\n' +
                       'Reference: ' + job.projectReference + '\n' +
                       'Address: ' + job.address + '\n' +
                       'Date: ' + new Date(job.createdAt).toLocaleDateString() + '\n\n' +
                       'Best regards,\n' + STATE.user.name + '\nEMG Energy';

            window.location.href = 'mailto:' + recipient + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
            log('‚úâÔ∏è Email opened for: ' + job.projectReference);
        }

        function saveManagerNotes() {
            if (!STATE.currentJob) return;

            var job = STATE.jobs.find(function(j) { return j.jobId === STATE.currentJob.jobId; });
            if (!job) return;

            if (!job.managerInputs) job.managerInputs = {};
            job.managerInputs.notes = document.getElementById('edit-manager-notes').value.trim();

            save();
            log('‚úÖ Manager notes saved');
            alert('‚úÖ Manager Notes Saved!');
        }

        function generateAIRecommendations(silent) {
            if (!STATE.currentJob) return;

            var job = STATE.jobs.find(function(j) { return j.jobId === STATE.currentJob.jobId; });
            if (!job) return;

            if (!silent) log('ü§ñ Generating recommendations...');

            var recommendations = [];
            var aiAnalysis = null;

            // Analyze survey completion
            if (job.jobTypeId && job.checkedItems) {
                aiAnalysis = AI_PROCESSOR.analyzeProject(job);

                recommendations.push('SURVEY COMPLETION ANALYSIS');
                recommendations.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                recommendations.push('Overall completion: ' + aiAnalysis.completionPercentage + '%');
                recommendations.push('');

                if (aiAnalysis.completionPercentage < 70) {
                    recommendations.push('‚ö†Ô∏è PRIORITY: Survey incomplete. Address outstanding items before final submission.');
                    recommendations.push('');
                }
            }

            // Analyze voice notes and professional text for common issues
            recommendations.push('TECHNICAL RECOMMENDATIONS');
            recommendations.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            var allText = '';
            if (job.voiceNotes) {
                for (var i = 0; i < job.voiceNotes.length; i++) {
                    allText += ' ' + job.voiceNotes[i].transcription.toLowerCase();
                }
            }

            // Building fabric recommendations
            if (allText.indexOf('solid brick') !== -1 || allText.indexOf('solid wall') !== -1) {
                recommendations.push('‚Ä¢ WALL INSULATION: Solid wall construction identified. Recommend external or internal wall insulation to achieve U-value ‚â§0.21 W/m¬≤K (Part L compliance). Estimated energy savings: 25-35% on heating costs.');
            }
            if (allText.indexOf('cavity') !== -1 && allText.indexOf('insulation') === -1) {
                recommendations.push('‚Ä¢ CAVITY WALL: Cavity wall appears uninsulated. Recommend cavity wall insulation (100-150mm mineral wool or blown bead). Cost-effective upgrade, typical ROI: 3-5 years.');
            }

            // Glazing recommendations
            if (allText.indexOf('single glaz') !== -1) {
                recommendations.push('‚Ä¢ WINDOWS: Single glazing identified. CRITICAL upgrade required for Part L compliance. Recommend A-rated double/triple glazing (U-value ‚â§1.4 W/m¬≤K). Energy savings: 15-25% on heating.');
            }

            // Heating system recommendations
            if (allText.indexOf('boiler') !== -1) {
                if (allText.match(/\d+\s*year/) && allText.match(/(\d+)\s*year/)) {
                    var age = parseInt(allText.match(/(\d+)\s*year/)[1]);
                    if (age > 15) {
                        recommendations.push('‚Ä¢ BOILER REPLACEMENT: Unit over 15 years old. Recommend replacement with A-rated condensing boiler (SEDBUK 90%+). Estimated savings: 25-30% on heating costs, improved reliability.');
                    }
                }
                if (allText.indexOf('condensing') === -1 && allText.indexOf('combi') === -1) {
                    recommendations.push('‚Ä¢ HEATING UPGRADE: Consider upgrading to modern condensing boiler or heat pump system for improved efficiency and reduced carbon emissions.');
                }
            }

            // Insulation recommendations
            if (allText.match(/(\d+)\s*mm/) && allText.indexOf('attic') !== -1) {
                var depth = parseInt(allText.match(/(\d+)\s*mm/)[1]);
                if (depth < 300) {
                    recommendations.push('‚Ä¢ ROOF INSULATION: Current depth ' + depth + 'mm below Part L standard (300mm minimum). Priority upgrade: Top-up to 300mm mineral wool. Cost: ‚Ç¨20-30/m¬≤, Payback: 2-3 years, Energy savings: 15-20%.');
                }
            }

            // Controls recommendations
            if (allText.indexOf('thermostat') === -1 && allText.indexOf('control') === -1) {
                recommendations.push('‚Ä¢ HEATING CONTROLS: Install modern programmable thermostat and TRVs on all radiators (except room with main thermostat). Savings: 8-15% on heating costs.');
            }

            // Ventilation recommendations
            if (allText.indexOf('ventilation') !== -1) {
                recommendations.push('‚Ä¢ VENTILATION: Verify mechanical ventilation flow rates comply with TGD Part F (kitchen ‚â•60 l/s, bathroom ‚â•15 l/s). Ensure filter maintenance schedule in place.');
            }

            // Renewable energy recommendations
            if (allText.indexOf('south facing') !== -1 || allText.indexOf('south-facing') !== -1) {
                recommendations.push('‚Ä¢ RENEWABLE ENERGY: South-facing roof aspect suitable for solar PV or solar thermal installation. Consider 3-4kWp solar PV system. Typical ROI: 7-10 years, 40-60% electricity offset.');
            }

            // Photo analysis recommendations
            if (job.photos && job.photos.length > 0) {
                recommendations.push('');
                recommendations.push('PHOTO ANALYSIS INSIGHTS');
                recommendations.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                var photoInsights = [];
                for (var i = 0; i < job.photos.length; i++) {
                    if (job.photos[i].extracted && job.photos[i].extracted.length > 50) {
                        var extracted = job.photos[i].extracted.toLowerCase();

                        if (extracted.indexOf('boiler') !== -1) {
                            photoInsights.push('‚Ä¢ Photo ' + (i+1) + ': Equipment data captured - verify boiler specifications and service history');
                        }
                        if (extracted.indexOf('temperature') !== -1 || extracted.indexOf('¬∞c') !== -1) {
                            photoInsights.push('‚Ä¢ Photo ' + (i+1) + ': Temperature data recorded - compare against comfort standards (21¬∞C living, 18¬∞C bedrooms)');
                        }
                        if (extracted.indexOf('insulation') !== -1) {
                            photoInsights.push('‚Ä¢ Photo ' + (i+1) + ': Insulation specifications documented - verify thickness meets Part L requirements');
                        }
                    }
                }

                if (photoInsights.length > 0) {
                    recommendations = recommendations.concat(photoInsights);
                } else {
                    recommendations.push('‚Ä¢ ' + job.photos.length + ' photos captured for visual documentation. Recommend adding notes for key equipment and measurements.');
                }
            }

            // Compliance recommendations
            recommendations.push('');
            recommendations.push('REGULATORY COMPLIANCE');
            recommendations.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            recommendations.push('‚Ä¢ Complete DEAP assessment using surveyed data to determine BER rating');
            recommendations.push('‚Ä¢ Conduct air tightness test (target: <7 m¬≥/h/m¬≤ @ 50Pa for new builds)');
            recommendations.push('‚Ä¢ Verify all upgrades comply with TGD L 2022 and Building Regulations 1997-2023');
            recommendations.push('‚Ä¢ Document U-values for all thermal elements (walls, roof, floor, windows, doors)');
            recommendations.push('‚Ä¢ Ensure heating system sizing meets heat loss calculations (EN 12831)');

            // Next steps
            recommendations.push('');
            recommendations.push('NEXT STEPS');
            recommendations.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            recommendations.push('1. Review and approve this report');
            recommendations.push('2. Complete DEAP assessment for BER certificate');
            recommendations.push('3. Provide client with upgrade cost estimates and ROI analysis');
            recommendations.push('4. Schedule follow-up site visit if additional data required');
            recommendations.push('5. Submit final report to client with actionable recommendations');

            var fullRecommendations = recommendations.join('\n');

            document.getElementById('edit-ai-recommendations').value = fullRecommendations;

            if (!job.managerInputs) job.managerInputs = {};
            job.managerInputs.recommendations = fullRecommendations;

            if (!silent) {
                log('‚úÖ Recommendations generated');
                alert('‚úÖ Recommendations Generated!\n\nBased on:\n‚Ä¢ Survey completion: ' + (aiAnalysis ? aiAnalysis.completionPercentage + '%' : 'N/A') + '\n‚Ä¢ Voice notes: ' + (job.voiceNotes ? job.voiceNotes.length : 0) + '\n‚Ä¢ Photos with OCR: ' + (job.photos ? job.photos.length : 0) + '\n\nReview and edit as needed.');
            }
        }

        function approveAndFinalizeReport() {
            if (!STATE.currentJob) return;

            // Save all changes first
            saveJobChanges();

            // Mark as completed
            var job = STATE.jobs.find(function(j) { return j.jobId === STATE.currentJob.jobId; });
            if (job) {
                job.status = 'completed';
                if (!job.managerInputs) job.managerInputs = {};
                job.managerInputs.approvedAt = new Date().toISOString();
                job.managerInputs.approvedBy = STATE.loggedInUser;
                save();
                renderJobs();
            }

            // Generate PDF
            generateJobPDF(STATE.currentJob.jobId);

            // Send email notification
            setTimeout(function() {
                emailJob(STATE.currentJob.jobId);
            }, 1000);

            log('‚úÖ Report approved and finalized: ' + STATE.currentJob.projectReference);
            alert('‚úÖ Report Approved!\n\nThe report has been:\n‚Ä¢ Saved with your edits\n‚Ä¢ Marked as Completed\n‚Ä¢ PDF generated and downloaded\n‚Ä¢ Email notification prepared\n\nPlease check your Downloads folder for the PDF.');

            closeJobModal();
        }

        function emailJob(jobId) {
            var job = STATE.jobs.find(function(j) { return j.jobId === jobId; });
            if (!job) return;

            // Automatic email to manager (gaeilge@gmail.com)
            var recipient = 'gaeilge@gmail.com';
            var subject = 'EMG Energy BER Assessment Report - ' + job.projectReference;

            // Build professional email body
            var body = 'Dear Manager,\n\n';
            body += 'The Building Energy Assessment Report for the following project is ready for your review:\n\n';
            body += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            body += 'PROJECT DETAILS\n';
            body += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            body += 'Reference: ' + job.projectReference + '\n';
            body += 'Address: ' + job.address + '\n';
            body += 'Status: ' + job.status.toUpperCase().replace('-', ' ') + '\n';
            body += 'Assessor: ' + (job.assignedTo || 'EMG Energy Surveyor') + '\n';
            body += 'Survey Date: ' + new Date(job.createdAt).toLocaleDateString('en-IE') + '\n\n';

            // Add completion status if available
            if (job.jobTypeId && job.checkedItems) {
                var aiAnalysis = AI_PROCESSOR.analyzeProject(job);
                body += 'Survey Completion: ' + aiAnalysis.completionPercentage + '%\n';
                body += 'Voice Notes: ' + (job.voiceNotes ? job.voiceNotes.length : 0) + '\n';
                body += 'Photos: ' + (job.photos ? job.photos.length : 0) + '\n\n';
            }

            body += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            body += 'NEXT STEPS\n';
            body += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            body += '1. Review the AI-generated professional report text in the dashboard\n';
            body += '2. Edit any observations as needed\n';
            body += '3. Click "Download PDF" to generate the final report\n';
            body += '4. Forward the report to the client\n\n';

            body += 'Access the dashboard here: ' + window.location.href + '\n\n';
            body += 'Best regards,\n';
            body += 'EMG Energy Survey System\n\n';
            body += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
            body += 'EMG Energy Consultants\n';
            body += 'Suite 17, Block A, Clare Technology Park\n';
            body += 'Ennis, Co. Clare, Ireland\n';
            body += 'Tel: 065 672 9090 | Mobile: 087 944 4470\n';
            body += 'Email: info@emgenergy.ie\n';
            body += 'Web: www.emgenergy.ie';

            // Open email client
            window.location.href = 'mailto:' + recipient + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);

            log('‚úâÔ∏è Email notification sent to: ' + recipient);
            alert('üìß Email Notification\n\nOpening email to: ' + recipient + '\n\nProject: ' + job.projectReference + '\n\nYour default email client will open with a pre-filled message. Click Send to complete.');
        }

        // ============= JOB DETAILS MODAL =============
        function viewJobDetails(jobId) {
            var job = STATE.jobs.find(function(j) { return j.jobId === jobId; });
            if (!job) return;

            STATE.currentJob = job;

            // Populate modal
            document.getElementById('modalTitle').textContent = job.projectReference;
            document.getElementById('edit-ref').value = job.projectReference;
            document.getElementById('edit-address').value = job.address;
            document.getElementById('edit-status').value = job.status;
            document.getElementById('edit-created').textContent = new Date(job.createdAt).toLocaleString();
            document.getElementById('edit-createdby').textContent = job.createdBy || 'Field Operator';
            document.getElementById('edit-manager-notes').value = (job.managerInputs && job.managerInputs.notes) || '';

            // Auto-generate recommendations if they don't exist
            if (!job.managerInputs || !job.managerInputs.recommendations) {
                setTimeout(function() {
                    generateAIRecommendations(true); // Pass true for silent mode
                }, 500);
            } else {
                document.getElementById('edit-ai-recommendations').value = job.managerInputs.recommendations;
            }

            // Populate staff dropdown
            var staffSel = document.getElementById('edit-staff');
            staffSel.innerHTML = '<option value="">Unassigned</option>';
            for (var i = 0; i < STATE.staffList.length; i++) {
                var opt = document.createElement('option');
                opt.value = STATE.staffList[i];
                opt.textContent = STATE.staffList[i];
                if (job.assignedTo === STATE.staffList[i]) opt.selected = true;
                staffSel.appendChild(opt);
            }

            // Display voice notes
            var notesHtml = '';
            if (job.voiceNotes && job.voiceNotes.length > 0) {
                document.getElementById('notes-count').textContent = job.voiceNotes.length;
                document.getElementById('no-notes').style.display = 'none';
                for (var i = 0; i < job.voiceNotes.length; i++) {
                    var note = job.voiceNotes[i];
                    notesHtml += '<div class="note-item">' +
                        '<div class="note-item-header">' +
                            '<span class="note-item-num">Note ' + (i+1) + '</span>' +
                            '<span class="note-item-time">' + new Date(note.captured_at).toLocaleString() + '</span>' +
                        '</div>' +
                        '<div class="note-item-text">' +
                            '<input type="text" value="' + note.transcription.replace(/"/g, '&quot;') + '" data-note-id="' + note.id + '">' +
                        '</div>' +
                    '</div>';
                }
            } else {
                document.getElementById('notes-count').textContent = '0';
                document.getElementById('no-notes').style.display = 'block';
            }
            document.getElementById('modal-notes').innerHTML = notesHtml;

            // Generate AI Professional Text for manager review
            var aiTextHtml = '';
            if (job.voiceNotes && job.voiceNotes.length > 0) {
                document.getElementById('no-ai-text').style.display = 'none';
                for (var i = 0; i < job.voiceNotes.length; i++) {
                    var note = job.voiceNotes[i];

                    // Check if manager has already edited this professional text
                    var professionalText = '';
                    if (job.managerInputs && job.managerInputs.professionalTexts && job.managerInputs.professionalTexts[note.id]) {
                        // Use manager's edited version
                        professionalText = job.managerInputs.professionalTexts[note.id];
                    } else {
                        // Generate AI professional text from raw transcription
                        professionalText = AI_PROCESSOR.professionalize(note.transcription);
                    }

                    aiTextHtml += '<div style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #2c5f2d;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">' +
                            '<span style="font-weight: 600; color: #2c5f2d;">Observation ' + (i+1) + '</span>' +
                            '<span style="font-size: 0.85em; color: #666;">' + new Date(note.captured_at).toLocaleString() + '</span>' +
                        '</div>' +
                        '<textarea data-ai-note-id="' + note.id + '" rows="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 0.95em; line-height: 1.6;">' +
                        professionalText + '</textarea>' +
                    '</div>';
                }
            } else {
                document.getElementById('no-ai-text').style.display = 'block';
            }
            document.getElementById('ai-professional-text-container').innerHTML = aiTextHtml;

            // Display photos
            var photosHtml = '';
            if (job.photos && job.photos.length > 0) {
                document.getElementById('photos-count').textContent = job.photos.length;
                document.getElementById('no-photos').style.display = 'none';
                for (var i = 0; i < job.photos.length; i++) {
                    var photo = job.photos[i];
                    photosHtml += '<div class="photo-item">' +
                        '<img src="' + photo.data + '" alt="Photo ' + (i+1) + '">' +
                        '<button class="photo-item-delete" onclick="deletePhoto(\'' + photo.id + '\')">&times;</button>' +
                    '</div>';
                }
            } else {
                document.getElementById('photos-count').textContent = '0';
                document.getElementById('no-photos').style.display = 'block';
            }
            document.getElementById('modal-photos').innerHTML = photosHtml;

            // Show modal
            document.getElementById('jobModal').classList.add('active');
            log('üìã Opened job details: ' + job.projectReference);
        }

        function closeJobModal() {
            document.getElementById('jobModal').classList.remove('active');
            STATE.currentJob = null;
            log('‚úñÔ∏è Closed job details');
        }

        function saveJobChanges() {
            if (!STATE.currentJob) return;

            var job = STATE.jobs.find(function(j) { return j.jobId === STATE.currentJob.jobId; });
            if (!job) return;

            // Update job fields
            job.address = document.getElementById('edit-address').value.trim();
            job.status = document.getElementById('edit-status').value;
            job.assignedTo = document.getElementById('edit-staff').value || null;

            if (!job.managerInputs) job.managerInputs = {};
            job.managerInputs.notes = document.getElementById('edit-manager-notes').value.trim();
            job.managerInputs.recommendations = document.getElementById('edit-ai-recommendations').value.trim();

            // Update voice notes
            var noteInputs = document.querySelectorAll('#modal-notes input[data-note-id]');
            for (var i = 0; i < noteInputs.length; i++) {
                var noteId = noteInputs[i].getAttribute('data-note-id');
                var newText = noteInputs[i].value.trim();
                var note = job.voiceNotes.find(function(n) { return n.id === noteId; });
                if (note) note.transcription = newText;
            }

            // Save manager-edited AI professional texts
            if (!job.managerInputs.professionalTexts) {
                job.managerInputs.professionalTexts = {};
            }
            var aiTextInputs = document.querySelectorAll('textarea[data-ai-note-id]');
            for (var i = 0; i < aiTextInputs.length; i++) {
                var noteId = aiTextInputs[i].getAttribute('data-ai-note-id');
                var editedText = aiTextInputs[i].value.trim();
                job.managerInputs.professionalTexts[noteId] = editedText;
            }

            // Save to localStorage
            localStorage.setItem('emg_all_jobs', JSON.stringify(STATE.jobs));

            log('‚úÖ Saved changes: ' + job.projectReference);
            alert('‚úÖ Changes saved successfully!');

            closeJobModal();
            loadData();
        }

        function deletePhoto(photoId) {
            if (!STATE.currentJob) return;
            if (!confirm('Delete this photo?')) return;

            var job = STATE.jobs.find(function(j) { return j.jobId === STATE.currentJob.jobId; });
            if (!job || !job.photos) return;

            job.photos = job.photos.filter(function(p) { return p.id !== photoId; });
            localStorage.setItem('emg_all_jobs', JSON.stringify(STATE.jobs));

            log('üóëÔ∏è Deleted photo');
            viewJobDetails(job.jobId); // Reload modal
        }

        function deleteJobFromModal() {
            if (!STATE.currentJob) return;
            if (!confirm('‚ö†Ô∏è Delete this project? This cannot be undone.')) return;

            STATE.jobs = STATE.jobs.filter(function(j) { return j.jobId !== STATE.currentJob.jobId; });
            localStorage.setItem('emg_all_jobs', JSON.stringify(STATE.jobs));

            log('üóëÔ∏è Deleted job: ' + STATE.currentJob.projectReference);
            closeJobModal();
            loadData();
        }

        // Close modal when clicking outside
        window.onclick = function(e) {
            var modal = document.getElementById('jobModal');
            if (e.target === modal) closeJobModal();
        };

        function deleteJob(jobId) {
            if (!confirm('‚ö†Ô∏è Delete this project? This cannot be undone.')) return;

            STATE.jobs = STATE.jobs.filter(function(j) { return j.jobId !== jobId; });
            localStorage.setItem('emg_all_jobs', JSON.stringify(STATE.jobs));

            log('üóëÔ∏è Deleted job: ' + jobId);
            loadData();
        }

        // ============= AUTO REFRESH =============
        setInterval(function() {
            var before = STATE.jobs.length;
            var data = localStorage.getItem('emg_all_jobs');
            STATE.jobs = data ? JSON.parse(data) : [];

            if (STATE.jobs.length !== before) {
                log('üîÑ Data refreshed (' + STATE.jobs.length + ' jobs)');
                loadData();
            }
        }, 5000);

        // ============= INIT =============
        log('üöÄ Dashboard v1 loading...');
        init();
    </script>
</body>
</html>
